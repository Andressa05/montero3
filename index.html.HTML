<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Gest√£o de Frotas e Caixa</title>
    <!-- Tailwind CSS CDN para estiliza√ß√£o moderna e responsiva -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos personalizados com foco na est√©tica azul e max-width */
        body {
            background-color: #f3f4f6; /* Fundo cinza claro */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .app-container {
            max-width: 1100px;
            margin: 0 auto;
            background-color: #ffffff;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            min-height: 100vh;
        }
        .header-bg {
            background-color: #1e40af; /* Azul forte */
            color: white;
        }
        .nav-link.active {
            border-bottom: 3px solid #60a5fa; /* Azul claro para aba ativa */
            color: #60a5fa;
            font-weight: 600;
        }
        .data-card {
            background-color: #eff6ff; /* Fundo azul muito claro */
            border-left: 4px solid #3b82f6; /* Borda azul */
        }
        .button-primary {
            background-color: #2563eb;
        }
        .button-primary:hover {
            background-color: #1d4ed8;
        }
        .button-danger {
            background-color: #dc2626;
        }
        .button-danger:hover {
            background-color: #b91c1c;
        }
        /* Estilo para a tabela de desdobramento (boletos/cheques) */
        .parcela-table th, .parcela-table td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }
        /* Estilo para alerta de vencimento */
        .alerta-vencimento {
            background-color: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }
        /* Garantir que o login cubra tudo e comece como flex */
        #loginPage {
            z-index: 100; 
            display: flex; /* Come√ßa como flex para garantir a centraliza√ß√£o */
        }
        /* Modais t√™m z-index mais alto que o login para aparecer por cima quando chamado */
        .modal-overlay {
            z-index: 1000; 
        }
        /* Estilos do Canvas de Assinatura */
        .signature-canvas {
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: crosshair;
            background-color: #fff;
            /* Garante que o canvas n√£o seja redimensionado pelo CSS, apenas pelo JS */
            touch-action: none; 
        }
        .small-btn {
            @apply px-2 py-1 text-xs rounded transition duration-150;
        }

        /* Oculta colunas da tabela em mobile, se necess√°rio. Aqui n√£o ser√° necess√°rio pois foi substitu√≠do por cards em mobile */
        /* .acertos-tabela-mobile .placa-col, .acertos-tabela-mobile .comissao-col { @apply hidden md:table-cell; } */
    </style>
    <!-- Firebase V8 CDN (compat√≠vel com single HTML file) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
</head>
<body>

<!-- --------------------------------------- TELA DE LOGIN --------------------------------------- -->
<!-- Z-index alto para garantir que fique por cima de qualquer elemento por padr√£o -->
<div id="loginPage" class="fixed inset-0 bg-gray-100 items-center justify-center z-[100]"> 
    <div class="bg-white p-8 rounded-lg shadow-xl w-96">
        <h2 class="text-3xl font-bold mb-6 text-center text-blue-700">Login no Sistema</h2>
        <div class="mb-4">
            <label class="block text-gray-700 mb-2" for="usuario">Usu√°rio</label>
            <input type="text" id="usuario" value="master" class="w-full border border-gray-300 p-3 rounded focus:ring-blue-500 focus:border-blue-500" placeholder="Usu√°rio padr√£o: master">
        </div>
        <div class="mb-6 relative">
            <label class="block text-gray-700 mb-2" for="senha">Senha</label>
            <input type="password" id="senha" value="123mudar" class="w-full border border-gray-300 p-3 rounded focus:ring-blue-500 focus:border-blue-500" placeholder="Senha padr√£o: 123mudar">
            <button type="button" onclick="toggleSenha()" class="absolute right-3 top-[55%] text-gray-500 hover:text-blue-500">
                <span id="toggleIcon">üëÅÔ∏è</span>
            </button>
        </div>
        <button onclick="handleLogin()" class="w-full button-primary text-white p-3 rounded font-semibold transition duration-200">
            Entrar
        </button>
    </div>
</div>

<!-- --------------------------------------- TELA PRINCIPAL DO SISTEMA --------------------------------------- -->
<!-- Inicia hidden para garantir que n√£o apare√ßa na tela de login -->
<div id="appPage" class="app-container hidden">

    <!-- Header do Sistema -->
    <header class="header-bg p-4 flex justify-between items-center sticky top-0 z-50">
        <div class="flex items-center">
            <h1 id="nomeEmpresaHeader" class="text-xl font-bold">Nome da Empresa</h1>
            <button onclick="abrirModalEmpresa()" class="ml-4 text-blue-300 hover:text-white" title="Alterar Nome da Empresa">
                ‚úèÔ∏è
            </button>
        </div>
        <div class="flex items-center">
            <button onclick="handleLogout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded transition duration-200">
                Sair
            </button>
        </div>
    </header>

    <!-- Navega√ß√£o de Abas -->
    <nav class="bg-white border-b border-gray-200 sticky top-[68px] z-40">
        <div class="flex">
            <button id="tabAcertos" onclick="changeTab('acertos')" class="nav-link px-6 py-3 text-gray-600 hover:text-blue-700 active">
                üìã Acertos de Viagem
            </button>
            <button id="tabCaixa" onclick="changeTab('caixa')" class="nav-link px-6 py-3 text-gray-600 hover:text-blue-700">
                üìä Entrada / Sa√≠da (Caixa)
            </button>
            <button id="tabCaminhao" onclick="changeTab('caminhao')" class="nav-link px-6 py-3 text-gray-600 hover:text-blue-700">
                üöö Cadastro de Caminh√£o
            </button>
        </div>
    </nav>

    <!-- Conte√∫do das Abas -->
    <main class="p-6">

        <!-- ALERTA DE VENCIMENTOS (Fixado no topo da main) -->
        <div id="alertaVencimentos" class="hidden alerta-vencimento p-3 rounded-lg mb-6 shadow">
            <p class="font-semibold">üîî **Alerta de Vencimentos!**</p>
            <ul id="listaVencimentos" class="list-disc list-inside mt-1 text-sm">
                <!-- Vencimentos ser√£o injetados aqui -->
            </ul>
        </div>
        
        <!-- --------------------------------------- ABA: ACERTOS DE VIAGEM --------------------------------------- -->
        <div id="acertos" class="tab-content">
            <h2 class="text-2xl font-semibold text-blue-700 mb-4">Registro de Acertos de Viagem</h2>
            
            <!-- Formul√°rio de Acerto -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-md mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 mb-1">Motorista <span class="text-red-500">*</span></label>
                        <input type="text" id="motoristaAcerto" class="w-full border p-2 rounded" placeholder="Nome do Motorista" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Caminh√£o <span class="text-red-500">*</span></label>
                        <select id="caminhaoAcerto" class="w-full border p-2 rounded" required>
                            <option value="">Selecione o Caminh√£o</option>
                            <!-- Op√ß√µes carregadas via JS -->
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Valor do Frete <span class="text-red-500">*</span></label>
                        <input type="text" id="freteAcerto" oninput="formatAndCalculate('freteAcerto')" class="w-full border p-2 rounded text-right" placeholder="R$ 0,00" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Valor da Comiss√£o <span class="text-red-500">*</span></label>
                        <input type="text" id="comissaoAcerto" oninput="formatAndCalculate('comissaoAcerto')" class="w-full border p-2 rounded text-right" placeholder="R$ 0,00" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Forma de Pagamento</label>
                        <input type="text" id="formaPagamentoAcerto" class="w-full border p-2 rounded" placeholder="Ex: PIX, Dinheiro">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Data da Viagem</label>
                        <input type="date" id="dataViagemAcerto" class="w-full border p-2 rounded">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-1">Observa√ß√µes</label>
                    <textarea id="observacoesAcerto" class="w-full border p-2 rounded h-20" placeholder="Detalhes da viagem"></textarea>
                </div>

                <!-- Despesas da Viagem -->
                <h3 class="text-lg font-semibold mt-4 mb-2 text-gray-700">Despesas da Viagem</h3>
                <div id="containerDespesas" class="space-y-2 mb-4">
                    <!-- Despesas ser√£o adicionadas aqui -->
                </div>
                <div class="flex space-x-2">
                    <input type="text" id="descricaoDespesa" class="border p-2 rounded flex-grow" placeholder="Descri√ß√£o da Despesa">
                    <input type="text" id="valorDespesa" oninput="formatMoeda(this.id)" class="border p-2 rounded w-40 text-right" placeholder="R$ 0,00">
                    <button onclick="adicionarDespesa()" class="bg-green-600 hover:bg-green-700 text-white p-2 rounded">
                        ‚ûï Adicionar
                    </button>
                </div>

                <!-- Sobra Calculada -->
                <div class="mt-6 p-4 data-card flex justify-between items-center">
                    <span class="font-bold text-lg text-blue-800">Sobra da Viagem:</span>
                    <span id="sobraAcerto" class="font-bold text-xl text-green-700">R$ 0,00</span>
                </div>

                <!-- Bot√µes de A√ß√£o -->
                <div class="mt-6 flex space-x-4">
                    <button onclick="salvarAcerto()" class="button-primary text-white p-3 rounded font-semibold flex-grow">
                        üíæ Salvar Acerto
                    </button>
                    <button onclick="limparCamposAcerto()" class="bg-gray-400 hover:bg-gray-500 text-white p-3 rounded font-semibold w-28">
                        üßº Limpar
                    </button>
                </div>
            </div>

            <hr class="my-6">

            <!-- Relat√≥rio e Filtros de Acerto -->
            <h2 class="text-2xl font-semibold text-blue-700 mb-4">Acertos Registrados</h2>
            
            <div class="flex space-x-4 mb-4 items-end">
                <div>
                    <label class="block text-gray-700 mb-1">Data In√≠cio</label>
                    <input type="date" id="dataInicioAcerto" class="border p-2 rounded">
                </div>
                <div>
                    <label class="block text-gray-700 mb-1">Data Final</label>
                    <input type="date" id="dataFimAcerto" class="border p-2 rounded">
                </div>
                <button onclick="filtrarAcertos()" class="button-primary text-white p-2 rounded h-10">
                    üîé Filtrar
                </button>
            </div>

            <!-- Totais de Acerto -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                <div class="data-card p-3 rounded-lg">
                    <p class="text-sm text-gray-600">Total Frete:</p>
                    <p id="totalFreteAcerto" class="text-lg font-bold text-blue-800">R$ 0,00</p>
                </div>
                <div class="data-card p-3 rounded-lg">
                    <p class="text-sm text-gray-600">Total Comiss√£o:</p>
                    <p id="totalComissaoAcerto" class="text-lg font-bold text-red-600">R$ 0,00</p>
                </div>
                <div class="data-card p-3 rounded-lg">
                    <p class="text-sm text-gray-600">Total Despesas:</p>
                    <p id="totalDespesasAcerto" class="text-lg font-bold text-red-600">R$ 0,00</p>
                </div>
                <div class="data-card p-3 rounded-lg">
                    <p class="text-sm text-gray-600">Total Sobra:</p>
                    <p id="totalSobraAcerto" class="text-lg font-bold text-green-700">R$ 0,00</p>
                </div>
            </div>

            <!-- Tabela de Acertos (Desktop) -->
            <div class="hidden md:block overflow-x-auto bg-white p-4 rounded-lg shadow">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="ordenarTabela('acertosTable', 0)">Motorista</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Caminh√£o</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="ordenarTabela('acertosTable', 2)">Frete</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="ordenarTabela('acertosTable', 3)">Comiss√£o</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="ordenarTabela('acertosTable', 4)">Despesas</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="ordenarTabela('acertosTable', 5)">Sobra</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="acertosTable" class="bg-white divide-y divide-gray-200">
                        <!-- Linhas de acerto ser√£o injetadas aqui -->
                    </tbody>
                </table>
            </div>

            <!-- Lista de Acertos (Mobile/Cards) -->
            <div id="acertosMobileList" class="md:hidden space-y-4">
                <!-- Cards de acerto ser√£o injetados aqui (mobile) -->
            </div>
            
            <div class="mt-4 flex justify-end">
                <button onclick="gerarRelatorioAcertoPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold">
                    üì§ Relat√≥rio PDF (Acertos)
                </button>
            </div>
        </div>

        <!-- --------------------------------------- ABA: ENTRADA / SA√çDA (CAIXA) --------------------------------------- -->
        <div id="caixa" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-blue-700 mb-4">Controle de Caixa (Entrada / Sa√≠da)</h2>

            <!-- Formul√°rio de Lan√ßamento Manual -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-md mb-6">
                <h3 class="text-lg font-semibold text-gray-700 mb-4">Lan√ßamentos</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 mb-1">Tipo <span class="text-red-500">*</span></label>
                        <select id="tipoCaixa" onchange="toggleVencimentoCheque()" class="w-full border p-2 rounded">
                            <option value="entrada">Entrada</option>
                            <option value="saida">Sa√≠da</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Valor <span class="text-red-500">*</span></label>
                        <input type="text" id="valorCaixa" oninput="formatMoeda(this.id)" class="w-full border p-2 rounded text-right" placeholder="R$ 0,00">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Data Lan√ßamento <span class="text-red-500">*</span></label>
                        <input type="date" id="dataCaixa" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Categoria</label>
                        <input type="text" id="categoriaCaixa" class="w-full border p-2 rounded" placeholder="Ex: Oficina, cart√£o">
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-gray-700 mb-1">Descri√ß√£o</label>
                    <textarea id="descricaoCaixa" class="w-full border p-2 rounded h-16" placeholder="Descri√ß√£o detalhada do lan√ßamento, nome lugar, nome banco"></textarea>
                </div>

                <!-- Op√ß√µes de Parcelamento (Sa√≠da) -->
                <div id="opcoesParcela" class="hidden bg-white p-4 rounded-lg shadow-inner mb-4">
                    <div class="flex flex-col md:flex-row space-y-4 md:space-y-0 md:space-x-6 items-center mb-4">
                        <div class="flex items-center">
                            <input type="checkbox" id="isBoleto" onchange="toggleVencimentoCheque()" class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                            <label class="ml-2 text-gray-700">Boleto (Vencimento)</label>
                        </div>
                        <div class="flex items-center">
                            <input type="checkbox" id="isCheque" onchange="toggleVencimentoCheque()" class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                            <label class="ml-2 text-gray-700">Cheque (Apresenta√ß√£o)</label>
                        </div>
                        <div class="flex-grow w-full md:w-auto">
                            <label class="block text-gray-700 mb-1">Qtd. Parcelas</label>
                            <input type="number" id="qtdParcelas" oninput="toggleVencimentoCheque()" value="1" min="1" class="w-full border p-2 rounded">
                        </div>
                        <div class="flex-grow w-full md:w-auto">
                            <label class="block text-gray-700 mb-1"><span id="labelVencimento">Vencimento da 1¬™ Parcela</span></label>
                            <input type="date" id="dataVencimento" onchange="toggleVencimentoCheque()" class="w-full border p-2 rounded">
                        </div>
                    </div>
                    
                    <!-- Desdobramento de Parcelas -->
                    <div id="desdobramentoParcelas" class="hidden mt-4">
                        <h4 class="font-semibold mb-2">Detalhes das Parcelas:</h4>
                        <div class="overflow-x-auto">
                            <table class="parcela-table min-w-full text-sm">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Valor</th>
                                        <th id="headerDataParcela">Vencimento</th>
                                        <th>A√ß√µes</th>
                                    </tr>
                                </thead>
                                <tbody id="tabelaParcelas">
                                    <!-- Parcelas ser√£o injetadas aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="flex space-x-4 mt-4">
                    <button onclick="salvarLancamentoCaixa()" class="button-primary text-white p-3 rounded font-semibold flex-grow">
                        üíæ Salvar Lan√ßamento
                    </button>
                    <!-- Novo bot√£o para Sugest√£o de Categoria via Gemini -->
                    <button onclick="sugerirCategoria()" class="bg-yellow-500 hover:bg-yellow-600 text-white p-3 rounded font-semibold w-40">
                        ‚ú® Sugerir Categoria
                    </button>
                </div>
            </div>

            <hr class="my-6">

            <!-- Filtros de Caixa -->
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Filtros e Relat√≥rios</h3>
            <div class="bg-white p-4 rounded-lg shadow mb-6">
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 items-end">
                    <!-- Filtro por M√™s (Checkbox e M√™s) -->
                    <div class="col-span-2 flex flex-col md:flex-row items-end space-y-2 md:space-y-0 md:space-x-4">
                        <div>
                            <label class="block text-gray-700 mb-1">M√™s de An√°lise</label>
                            <input type="month" id="filtroMes" class="border p-2 rounded w-40">
                        </div>
                        <div class="flex items-center h-10">
                            <input type="checkbox" id="filtroTipoRecebimento" class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                            <label class="ml-2 text-gray-700">Recebimentos/Realizado</label>
                        </div>
                        <div class="flex items-center h-10">
                            <input type="checkbox" id="filtroTipoVencimento" class="w-4 h-4 text-blue-600 border-gray-300 rounded">
                            <label class="ml-2 text-gray-700">Vencimentos/Pagamentos</label>
                        </div>
                    </div>
                    
                    <!-- Filtro por Data Personalizada -->
                    <div class="col-span-2 grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-gray-700 mb-1">Data In√≠cio</label>
                            <input type="date" id="dataInicioCaixa" class="w-full border p-2 rounded">
                        </div>
                        <div>
                            <label class="block text-gray-700 mb-1">Data Fim</label>
                            <input type="date" id="dataFimCaixa" class="w-full border p-2 rounded">
                        </div>
                    </div>
                </div>
                
                <div class="mt-4 flex space-x-4">
                    <button id="btnAplicarFiltros" onclick="filtrarCaixa()" class="button-primary text-white p-2 rounded flex-grow">
                        üîé Aplicar Filtros
                    </button>
                    <button onclick="gerarRelatorioCaixaPDF()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded font-semibold">
                        üì§ Relat√≥rio PDF
                    </button>
                </div>
            </div>

            <!-- Totais e Saldo -->
            <div class="grid grid-cols-3 gap-4 mb-6">
                <div class="data-card p-3 rounded-lg">
                    <p class="text-sm text-gray-600">Total Entradas (M√™s/Per√≠odo):</p>
                    <p id="totalEntradasCaixa" class="text-lg font-bold text-green-700">R$ 0,00</p>
                </div>
                <div class="data-card p-3 rounded-lg">
                    <p class="text-sm text-gray-600">Total Sa√≠das (Vencidas/Pagas):</p>
                    <p id="totalSaidasCaixa" class="text-lg font-bold text-red-600">R$ 0,00</p>
                </div>
                <div class="data-card p-3 rounded-lg">
                    <p class="text-sm text-gray-600">Saldo no M√™s/Per√≠odo:</p>
                    <p id="saldoAtualCaixa" class="text-lg font-bold text-blue-800">R$ 0,00</p>
                </div>
            </div>

            <!-- Tabela de Lan√ßamentos -->
            <div class="overflow-x-auto bg-white p-4 rounded-lg shadow">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="ordenarTabela('caixaTable', 0)">Data</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Descri√ß√£o</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase cursor-pointer" onclick="ordenarTabela('caixaTable', 3)">Valor</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vencimento</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="caixaTable" class="bg-white divide-y divide-gray-200">
                        <!-- Lan√ßamentos ser√£o injetados aqui -->
                        <tr><td colspan="6" class="text-center py-4">Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>

        </div>

        <!-- --------------------------------------- ABA: CADASTRO DE CAMINH√ÉO --------------------------------------- -->
        <div id="caminhao" class="tab-content hidden">
            <h2 class="text-2xl font-semibold text-blue-700 mb-4" id="tituloCaminhao">Cadastro de Caminh√µes</h2>

            <!-- Formul√°rio de Cadastro de Caminh√£o -->
            <div class="bg-gray-50 p-6 rounded-lg shadow-md mb-6">
                <input type="hidden" id="caminhaoEmEdicaoId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 mb-1">Nome do Caminh√£o <span class="text-red-500">*</span></label>
                        <input type="text" id="nomeCaminhao" class="w-full border p-2 rounded" placeholder="Ex: Volvo FH 540" required>
                    </div>
                    <div>
                        <label class="block text-gray-700 mb-1">Placa do Caminh√£o (Brasil) <span class="text-red-500">*</span></label>
                        <input type="text" id="placaCaminhao" oninput="formatPlaca(this)" maxlength="8" class="w-full border p-2 rounded uppercase" placeholder="AAA-1234 (Mercosul: AAA1B23)">
                    </div>
                </div>
                <div class="flex space-x-4">
                    <button onclick="salvarCaminhao()" class="button-primary text-white p-3 rounded font-semibold flex-grow" id="btnSalvarCaminhao">
                        üíæ Salvar Caminh√£o
                    </button>
                    <button onclick="limparCamposCaminhao()" class="bg-gray-400 hover:bg-gray-500 text-white p-3 rounded font-semibold w-28 hidden" id="btnLimparCaminhao">
                        üßº Limpar
                    </button>
                </div>
            </div>

            <hr class="my-6">

            <!-- Tabela de Caminh√µes -->
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Caminh√µes Cadastrados</h3>
            <div class="overflow-x-auto bg-white p-4 rounded-lg shadow">
                <table id="caminhoesTable" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nome</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Placa</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="caminhoesTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Caminh√µes ser√£o injetados aqui -->
                    </tbody>
                </table>
            </div>

        </div>

    </main>
</div>

<!-- --------------------------------------- MODAIS --------------------------------------- -->

<!-- Modal: Alterar Nome da Empresa -->
<div id="modalEmpresa" class="modal-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-96 shadow-xl">
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-gray-900">‚úèÔ∏è Alterar Nome da Empresa</h3>
            <button onclick="fecharModalEmpresa()" class="text-gray-500 hover:text-red-500">‚úñ</button>
        </div>
        <input id="novoNomeEmpresa" type="text" placeholder="Digite o novo nome" class="w-full border rounded p-3 mb-4">
        <button onclick="salvarNomeEmpresa()" class="button-primary text-white px-4 py-2 rounded w-full">
            Salvar
        </button>
    </div>
</div>

<!-- Modal: Resumo Detalhado da Viagem -->
<div id="modalResumoViagem" class="modal-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center">
    <div class="bg-white rounded-lg p-8 w-11/12 max-w-lg shadow-xl">
        <div class="flex justify-between items-center mb-6 border-b pb-2">
            <h3 class="text-xl font-bold text-blue-700">üëÅÔ∏è Resumo Detalhado da Viagem</h3>
            <button onclick="fecharModalResumoViagem()" class="text-gray-500 hover:text-red-500">‚úñ</button>
        </div>
        
        <div id="resumoViagemContent" class="space-y-2 text-gray-700 text-sm">
            <p><strong>Data:</strong> <span id="resumoData"></span></p>
            <p><strong>Motorista:</strong> <span id="resumoMotorista"></span></p>
            <p><strong>Caminh√£o:</strong> <span id="resumoCaminhao"></span></p>
            <p><strong>Frete:</strong> <span id="resumoFrete" class="font-bold text-blue-700"></span></p>
            <p><strong>Comiss√£o:</strong> <span id="resumoComissao" class="font-bold text-red-600"></span></p>
            <p><strong>Forma de Pagamento:</strong> <span id="resumoFormaPagamento"></span></p>
            
            <div class="mt-4 pt-4 border-t">
                <h4 class="font-bold mb-1">Despesas:</h4>
                <ul id="resumoListaDespesas" class="list-disc space-y-1 text-xs pl-4">
                    <!-- Despesas Detalhadas aqui -->
                </ul>
                <p class="mt-2 text-sm"><strong>Total Despesas:</strong> <span id="resumoTotalDespesas" class="font-bold text-red-600"></span></p>
            </div>

            <div class="mt-4 pt-4 border-t">
                <p class="text-lg"><strong>SOBRA:</strong> <span id="resumoSobra" class="font-bold text-green-700"></span></p>
            </div>

            <p class="mt-4 text-xs italic">Observa√ß√µes: <span id="resumoObservacoes"></span></p>
        </div>

        <button onclick="fecharModalResumoViagem()" class="mt-6 bg-gray-400 hover:bg-gray-500 text-white px-4 py-2 rounded w-full">
            OK
        </button>
    </div>
</div>

<!-- Modal: Assinaturas para Recibo -->
<div id="modalAssinaturaRecibo" class="modal-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-11/12 max-w-2xl shadow-xl">
        <div class="flex justify-between items-center mb-6 border-b pb-2">
            <h3 class="text-xl font-bold text-blue-700">‚úçÔ∏è Assinaturas para o Recibo</h3>
            <button onclick="fecharModalAssinaturaRecibo()" class="text-gray-500 hover:text-red-500">‚úñ</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-gray-700 mb-2">Assinatura do Motorista:</label>
                <!-- Alterado o height para ser flex√≠vel em mobile -->
                <canvas id="canvasMotorista" class="signature-canvas w-full h-32"></canvas>
                <button onclick="limparAssinatura('Motorista')" class="button-danger text-white px-4 py-2 rounded w-full mt-2">
                    <span class="mr-1">üßº</span> Limpar Assinatura
                </button>
            </div>
            <div>
                <label class="block text-gray-700 mb-2">Assinatura do Propriet√°rio:</label>
                <!-- Alterado o height para ser flex√≠vel em mobile -->
                <canvas id="canvasProprietario" class="signature-canvas w-full h-32"></canvas>
                <button onclick="limparAssinatura('Proprietario')" class="button-danger text-white px-4 py-2 rounded w-full mt-2">
                    <span class="mr-1">üßº</span> Limpar Assinatura
                </button>
            </div>
        </div>

        <div class="mt-6 flex space-x-4">
            <button onclick="salvarAssinaturasEGerarRecibo()" class="button-primary text-white p-3 rounded font-semibold flex-grow">
                üíæ Salvar Assinaturas e Gerar Recibo
            </button>
            <button onclick="fecharModalAssinaturaRecibo()" class="bg-gray-400 hover:bg-gray-500 text-white p-3 rounded font-semibold w-28">
                Cancelar
            </button>
        </div>
    </div>
</div>

<!-- Modal: Recibo de Acerto (para visualiza√ß√£o final/PDF) - Adicionado ID para PDF -->
<div id="modalRecibo" class="modal-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center">
    <!-- Reduzida a largura para caber melhor no A4 -->
    <div class="bg-white rounded-lg p-8 w-11/12 max-w-sm shadow-xl"> 
        <div class="flex justify-between items-center mb-6 border-b pb-2">
            <h3 class="text-xl font-bold text-blue-700">üìÑ Recibo de Acerto</h3>
            <button onclick="fecharModalRecibo()" class="text-gray-500 hover:text-red-500">‚úñ</button>
        </div>
        
        <!-- Adicionado ID "reciboParaPDF" para html2canvas capturar o conte√∫do -->
        <div id="reciboParaPDF" class="space-y-3 text-gray-700">
            <!-- Conte√∫do do recibo ser√° injetado aqui -->
            <p><strong>Empresa:</strong> <span id="reciboEmpresa"></span></p>
            <p><strong>Motorista:</strong> <span id="reciboMotorista"></span></p>
            <p><strong>Caminh√£o:</strong> <span id="reciboCaminhao"></span></p>
            <p><strong>Data da Viagem:</strong> <span id="reciboData"></span></p>
            <p><strong>Valor da Comiss√£o:</strong> <span id="reciboComissao" class="font-bold text-red-600"></span></p>
            <p><strong>Observa√ß√µes:</strong> <span id="reciboObservacoes"></span></p>
            
            <!-- Assinaturas injetadas aqui -->
            <div class="mt-8 pt-8 border-t border-dashed">
                <div class="grid grid-cols-2 gap-4 text-center">
                    <div>
                        <img id="reciboAssMotorista" class="w-full h-16 border-b border-gray-400 object-contain mx-auto mb-1" src="">
                        <p class="text-sm">Assinatura do Motorista</p>
                    </div>
                    <div>
                        <img id="reciboAssProprietario" class="w-full h-16 border-b border-gray-400 object-contain mx-auto mb-1" src="">
                        <p class="text-sm">Assinatura do Propriet√°rio</p>
                    </div>
                </div>
            </div>

            <div class="mt-4 pt-4 border-t border-dashed">
                <p class="text-center italic text-sm">Comprovante gerado eletronicamente em <span id="reciboDataGeracao"></span></p>
            </div>
        </div>

        <button onclick="gerarReciboPDF()" class="mt-6 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full">
            Imprimir Recibo
        </button>
    </div>
</div>

<!-- Modal: Visualizar/Editar Lan√ßamento (Caixa) -->
<div id="modalCaixa" class="modal-overlay hidden fixed inset-0 bg-gray-900 bg-opacity-50 items-center justify-center">
    <div class="bg-white rounded-lg p-6 w-[700px] shadow-xl">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h3 class="text-xl font-bold text-blue-700" id="caixaModalTitle">Editar Lan√ßamento</h3>
            <button onclick="fecharModalCaixa()" class="text-gray-500 hover:text-red-500">‚úñ</button>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div><label class="block text-gray-700 mb-1">Tipo</label><select id="editTipoCaixa" class="w-full border p-2 rounded" onchange="toggleEditVencimentoCheque()"><option value="entrada">Entrada</option><option value="saida">Sa√≠da</option></select></div>
            <div><label class="block text-gray-700 mb-1">Valor</label><input type="text" id="editValorCaixa" oninput="formatMoeda(this.id)" class="w-full border p-2 rounded text-right"></div>
            <div><label class="block text-gray-700 mb-1">Data Lan√ßamento</label><input type="date" id="editDataCaixa" class="w-full border p-2 rounded"></div>
            <div><label class="block text-gray-700 mb-1">Categoria</label><input type="text" id="editCategoriaCaixa" class="w-full border p-2 rounded"></div>
        </div>
        <div class="mb-4">
            <label class="block text-gray-700 mb-1">Descri√ß√£o</label>
            <textarea id="editDescricaoCaixa" class="w-full border p-2 rounded h-16"></textarea>
        </div>
        
        <!-- Edi√ß√£o de Parcelas (Simplificada) -->
        <div id="editOpcoesParcela" class="hidden bg-gray-100 p-4 rounded-lg shadow-inner mb-4">
            <h4 class="font-semibold mb-2">Detalhes da Parcela <span id="editParcAtual">1</span> de <span id="editParcTotal">1</span>:</h4>
            <div class="flex space-x-4">
                <div class="flex-grow">
                    <label class="block text-gray-700 mb-1" id="editLabelVencimento">Vencimento/Apresenta√ß√£o</label>
                    <input type="date" id="editDataVencimento" class="w-full border p-2 rounded">
                </div>
            </div>
            <div class="mt-2 text-sm text-red-600">
                Para alterar o desdobramento de parcelas, use a fun√ß√£o de exclus√£o e refa√ßa o lan√ßamento.
            </div>
        </div>

        <input type="hidden" id="lancamentoIdCaixa">
        <button onclick="salvarEdicaoCaixa()" class="button-primary text-white p-3 rounded font-semibold w-full mt-4">
            Salvar Edi√ß√£o
        </button>
    </div>
</div>


<!-- --------------------------------------- SCRIPTS --------------------------------------- -->
<!-- Importa√ß√µes de PDF atualizadas: jsPDF + html2canvas para melhor renderiza√ß√£o de HTML -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script>
    // ** VARI√ÅVEIS GLOBAIS FIREBASE **
    const firebaseConfig = {
        apiKey: "AIzaSyAdz_cTwg0N97wGIT4juTl1OXs3-HJY0X8",
        authDomain: "montero-web.firebaseapp.com",
        projectId: "montero-web",
        storageBucket: "montero-web.firebasestorage.app",
        messagingSenderId: "673171025883",
        appId: "1:673171025883:web:8e845ea1460792e54bc1fe",
        measurementId: "G-TVDL4P5J6E"
    };

    // Inicializa Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ** VARI√ÅVEIS GLOBAIS DO SISTEMA **
    let despesasViagem = [];
    let acertoEmEdicaoId = null;
    let lancamentoEmEdicaoId = null;
    let caminhaoEmEdicaoId = null; // Vari√°vel para rastrear o caminh√£o em edi√ß√£o
    let canvasMotorista, ctxMotorista, isDrawingMotorista = false;
    let canvasProprietario, ctxProprietario, isDrawingProprietario = false;
    let acertoAtualData = null; // Para armazenar dados do acerto para o resumo/recibo
    window.caixaItems = []; // Array global para armazenar todos os itens do caixa
    

    // ----------------------------------------------------
    // # FUN√á√ïES DE UTILIDADE E FORMATA√á√ÉO
    // ----------------------------------------------------
    
    // ----------------- Helpers (In√≠cio do bloco) -----------------
    
    function parseNumber(value) {
      if (value === null || value === undefined) return 0;
      if (typeof value === 'number') return value;
      let s = String(value).trim();
      // remove R$ e espa√ßos
      s = s.replace(/[R$\s]/g,'');
      // se tem ponto e v√≠rgula, trata milhares e decimais
      if (s.indexOf('.') > -1 && s.indexOf(',') > -1) {
        s = s.replace(/\./g,'').replace(',', '.');
      } else {
        s = s.replace(',', '.');
      }
      const n = parseFloat(s);
      return isNaN(n) ? 0 : n;
    }

    // NOVA FUN√á√ÉO PARA ORDENA√á√ÉO DE DATAS
    function parseDateBR(value) {
        if (!value) return new Date(0);
        // Tenta extrair a parte da data e remover o status "(Vencido)", "(Pago)", etc.
        const datePart = value.split(' ')[0];
        const [dia, mes, ano] = datePart.split('/');
        if (!dia || !mes || !ano) return new Date(0);
        // Cria a data no formato YYYY-MM-DD para evitar problemas de fuso/locale (startOfDay)
        return new Date(parseInt(ano, 10), parseInt(mes, 10) - 1, parseInt(dia, 10));
    }
    
    function parseLocalDateFromInput(value) {
      // value esperado "YYYY-MM-DD" (input type=date)
      if (!value) return null;
      if (typeof value !== 'string') {
        const d = new Date(value);
        return isNaN(d) ? null : d;
      }
      const m = value.match(/^(\d{4})-(\d{2})-(\d{2})$/);
      if (m) return new Date(parseInt(m[1],10), parseInt(m[2],10)-1, parseInt(m[3],10));
      // fallback
      const d = new Date(value);
      return isNaN(d) ? null : d;
    }
    
    function toDate(v) {
      if (!v) return null;
      // Firestore Timestamp
      if (typeof v === 'object' && typeof v.toDate === 'function') {
        try { return v.toDate(); } catch(e) { /* fallback */ }
      }
      // epoch number
      if (typeof v === 'number') return new Date(v);
      // string ISO or YYYY-MM-DD or dd/mm/yyyy
      if (typeof v === 'string') {
        const s = v.trim();
        if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return parseLocalDateFromInput(s);
        if (/^\d{2}\/\d{2}\/\d{4}$/.test(s)) {
          const [d,m,y] = s.split('/');
          return new Date(parseInt(y,10), parseInt(m,10)-1, parseInt(d,10));
        }
        const d = new Date(s);
        if (!isNaN(d)) return d;
        return null;
      }
      // Date object?
      if (v instanceof Date) return v;
      return null;
    }
    
    function startOfDay(d) { if(!d) return null; const r = new Date(d); r.setHours(0,0,0,0); return r; }
    function endOfDay(d)   { if(!d) return null; const r = new Date(d); r.setHours(23,59,59,999); return r; }
    
    function formatBRL(v){ try { return new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0); } catch(e) { return 'R$ ' + (Math.round((v||0)*100)/100).toFixed(2); } }
    
    function inRange(date, start, end) {
      if (!date) return false;
      if (start && date < start) return false;
      if (end && date > end) return false;
      return true;
    }
    
    // NOVO HELPER: Normaliza data para compara√ß√£o (zera hora/minuto/segundo)
    function normalizeToDate(date) {
        if (!date) return null;
        const d = toDate(date); // Usa a fun√ß√£o toDate existente para converter
        if (!d || isNaN(d)) return null;
        d.setHours(0, 0, 0, 0); // zera hora, minuto e segundo
        return d;
    }


    /** Formata n√∫mero para moeda BRL em tempo real */
    function formatMoeda(elementId) {
        const input = document.getElementById(elementId);
        let value = input.value.replace(/\D/g, ""); // Remove tudo que n√£o √© d√≠gito
        
        if (value.length > 0) {
            value = (parseInt(value) / 100).toFixed(2).replace(".", ",");
            value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
            input.value = "R$" + value;
        } else {
            input.value = "";
        }
        // Dispara c√°lculo autom√°tico se for campo de acerto
        if (elementId === 'freteAcerto' || elementId === 'comissaoAcerto') {
            calcularSobra();
        }
    }

    /** Dispara o c√°lculo de sobra ap√≥s formata√ß√£o de moeda */
    function formatAndCalculate(elementId) {
        formatMoeda(elementId);
        calcularSobra();
    }

    /** Converte string de moeda BRL (R$ 1.234,56) para float (1234.56) */
    function currencyToFloat(currency) {
        if (!currency) return 0;
        // Tenta remover R$, pontos de milhar e substitui v√≠rgula por ponto decimal
        return parseNumber(currency);
    }
    
    /** Formata float (1234.56) para string BRL (R$ 1.234,56) */
    function floatToCurrency(float) {
        // Se o float for NaN, retorna R$ 0,00 para evitar R$ NaN
        if (isNaN(float)) return "R$ 0,00"; 
        return formatBRL(float);
    }
    
    /** Formata data YYYY-MM-DD para DD/MM/YYYY */
    function formatDateBR(dateString) {
        if (!dateString) return '';
        // Assumindo que a entrada √© YYYY-MM-DD
        const parts = dateString.split('-');
        if (parts.length === 3) {
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }
        return dateString;
    }

    /** Formata placa de carro (AAA1234, AAAB123) */
    function formatPlaca(input) {
        let value = input.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
        let formatted = '';
        if (value.length > 3) {
            formatted = value.substring(0, 3);
            // Adiciona h√≠fen para padr√£o antigo (AAA-1234) ou Mercosul (AAA1B23)
            if (value.length >= 7) {
                 formatted += '-' + value.substring(3, 7);
            } else if (value.length > 3) {
                 formatted += '-' + value.substring(3);
            }
        } else {
            formatted = value;
        }
        input.value = formatted;
    }


    // ----------------------------------------------------
    // # FUN√á√ïES DE TELA (LOGIN, TABS, MODAIS)
    // ----------------------------------------------------

    /** Login Fixo com localStorage */
    function handleLogin() {
        const usuario = document.getElementById("usuario").value;
        const senha = document.getElementById("senha").value;

        if (usuario === "master" && senha === "123mudar") {
            localStorage.setItem("usuarioLogado", "true");
            document.getElementById("loginPage").style.display = "none";
            document.getElementById("appPage").classList.remove("hidden");
            // Inicia o carregamento dos dados ap√≥s o login
            initSystem(); 
        } else {
            // Usando console.log em vez de alert para n√£o travar o ambiente
            console.error("Usu√°rio ou senha inv√°lidos!");
            // Exibir mensagem de erro na tela, se poss√≠vel
        }
    }

    /** Logout */
    function handleLogout() {
        localStorage.removeItem("usuarioLogado");
        document.getElementById("loginPage").style.display = "flex";
        document.getElementById("appPage").classList.add("hidden");
    }

    /** Exibir/Ocultar Senha */
    function toggleSenha() {
        const senhaInput = document.getElementById("senha");
        const iconSpan = document.getElementById("toggleIcon");
        if (senhaInput.type === "password") {
            senhaInput.type = "text";
            iconSpan.textContent = "üôà";
        } else {
            senhaInput.type = "password";
            iconSpan.textContent = "üëÅÔ∏è";
        }
    }

    /** Troca de Abas */
    function changeTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(tab => tab.classList.add('hidden'));
        document.getElementById(tabName).classList.remove('hidden');

        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        document.getElementById(`tab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');

        // Recarrega dados espec√≠ficos da aba
        if (tabName === 'acertos') carregarAcertos();
        if (tabName === 'caixa') loadAllCaixaAndFilter(); // Chamada principal de carga do caixa
        if (tabName === 'caminhao') carregarCaminhoes();
    }

    /** Modal Empresa */
    function abrirModalEmpresa() {
        document.getElementById("modalEmpresa").classList.remove("hidden");
        document.getElementById("modalEmpresa").style.display = "flex";
    }
    function fecharModalEmpresa() {
        document.getElementById("modalEmpresa").classList.add("hidden");
        document.getElementById("modalEmpresa").style.display = "none";
    }
    function salvarNomeEmpresa() {
        const novoNome = document.getElementById("novoNomeEmpresa").value;
        if (novoNome.trim() !== "") {
            localStorage.setItem("nomeEmpresa", novoNome);
            document.getElementById("nomeEmpresaHeader").innerText = novoNome;
            fecharModalEmpresa();
        }
    }

    /** Modal Recibo */
    function fecharModalRecibo() {
        document.getElementById('modalRecibo').classList.add('hidden');
        document.getElementById('modalRecibo').style.display = "none";
    }

    /** Modal Resumo Viagem */
    function fecharModalResumoViagem() {
        document.getElementById('modalResumoViagem').classList.add('hidden');
        document.getElementById('modalResumoViagem').style.display = "none";
    }
    
    /** Modal Assinatura */
    function fecharModalAssinaturaRecibo() {
        document.getElementById('modalAssinaturaRecibo').classList.add('hidden');
        document.getElementById('modalAssinaturaRecibo').style.display = "none";
    }

    // ----------------------------------------------------
    // # L√ìGICA DO ACERTO DE VIAGEM (ABA ACERTOS)
    // ----------------------------------------------------

    /** Adiciona despesa √† lista tempor√°ria */
    function adicionarDespesa() {
        const descricao = document.getElementById('descricaoDespesa').value.trim();
        const valorStr = document.getElementById('valorDespesa').value;
        const valor = currencyToFloat(valorStr);

        if (descricao && valor > 0) {
            despesasViagem.push({ descricao, valor });
            renderizarDespesas();
            calcularSobra();
            document.getElementById('descricaoDespesa').value = '';
            document.getElementById('valorDespesa').value = '';
        } else {
            console.error('Preencha a descri√ß√£o e o valor da despesa.');
        }
    }

    /** Renderiza a lista de despesas na tela */
    function renderizarDespesas() {
        const container = document.getElementById('containerDespesas');
        container.innerHTML = despesasViagem.map((d, index) => `
            <div class="flex justify-between items-center bg-white p-3 rounded border">
                <span>${d.descricao}</span>
                <div class="flex items-center space-x-3">
                    <span class="font-semibold text-red-600">${floatToCurrency(d.valor)}</span>
                    <button onclick="excluirDespesa(${index})" class="text-red-500 hover:text-red-700">
                        ‚ùå
                    </button>
                </div>
            </div>
        `).join('');
    }

    /** Exclui despesa da lista tempor√°ria */
    function excluirDespesa(index) {
        despesasViagem.splice(index, 1);
        renderizarDespesas();
        calcularSobra();
    }

    /** Calcula a Sobra em tempo real */
    function calcularSobra() {
        const frete = currencyToFloat(document.getElementById('freteAcerto').value);
        const comissao = currencyToFloat(document.getElementById('comissaoAcerto').value);
        const totalDespesas = despesasViagem.reduce((sum, d) => sum + d.valor, 0);

        const sobra = frete - comissao - totalDespesas;
        document.getElementById('sobraAcerto').textContent = floatToCurrency(sobra);
    }

    /** Salva ou Edita Acerto e Lan√ßa Automaticamente no Caixa */
    async function salvarAcerto() {
        const motorista = document.getElementById('motoristaAcerto').value.trim();
        const caminhaoId = document.getElementById('caminhaoAcerto').value;
        const frete = currencyToFloat(document.getElementById('freteAcerto').value);
        const comissao = currencyToFloat(document.getElementById('comissaoAcerto').value);
        const formaPagamento = document.getElementById('formaPagamentoAcerto').value.trim();
        const observacoes = document.getElementById('observacoesAcerto').value.trim();
        const dataViagem = document.getElementById('dataViagemAcerto').value;
        const sobra = currencyToFloat(document.getElementById('sobraAcerto').textContent);

        if (!motorista || !caminhaoId || frete <= 0 || comissao < 0 || !dataViagem) {
            console.error('Preencha Motorista, Caminh√£o, Frete, Comiss√£o e Data de Viagem!');
            return;
        }

        const caminhaoNome = document.getElementById('caminhaoAcerto').options[document.getElementById('caminhaoAcerto').selectedIndex].text;
        const totalDespesas = despesasViagem.reduce((sum, d) => sum + d.valor, 0);

        const acertoData = {
            motorista,
            caminhaoId,
            caminhaoNome,
            frete,
            comissao,
            formaPagamento,
            observacoes,
            dataViagem: firebase.firestore.Timestamp.fromDate(new Date(dataViagem + 'T12:00:00')),
            despesas: despesasViagem,
            totalDespesas,
            sobra,
            dataRegistro: firebase.firestore.FieldValue.serverTimestamp(),
            status: 'concluido'
        };

        try {
            if (acertoEmEdicaoId) {
                // 1. Edi√ß√£o de Acerto
                await db.collection("acertos").doc(acertoEmEdicaoId).update(acertoData);
                await atualizarLancamentoCaixaAcerto(acertoEmEdicaoId, motorista, sobra, dataViagem);
                console.log('Acerto atualizado e Sobra no Caixa sincronizada com sucesso!');
            } else {
                // 2. Novo Acerto
                const docRef = await db.collection("acertos").add(acertoData);
                // 3. Lan√ßamento Autom√°tico da Sobra no Caixa
                if (sobra > 0) {
                    await lancarSobraNoCaixa(docRef.id, motorista, sobra, dataViagem);
                }
                console.log('Acerto salvo e Sobra de Viagem lan√ßada no Caixa!');
            }
            
            limparCamposAcerto();
            carregarAcertos(); // Atualiza a tabela
            loadAllCaixaAndFilter(); // Atualiza o caixa
        } catch (error) {
            console.error("Erro ao salvar acerto:", error);
            // alert("Erro ao salvar acerto. Verifique o console."); // N√£o usar alert
        }
    }

    /** Lan√ßamento Autom√°tico da Sobra no Caixa */
    async function lancarSobraNoCaixa(acertoId, motorista, sobra, dataViagem) {
        const lancamentoData = {
            tipo: 'entrada',
            valor: sobra,
            data: firebase.firestore.Timestamp.fromDate(new Date(dataViagem + 'T12:00:00')),
            // CORRE√á√ÉO 1: Remover o ID do acerto da descri√ß√£o
            descricao: `Sobra Viagem - Motorista: ${motorista}`,
            categoria: 'Sobra Viagem',
            status: 'recebido', // Sobra de Acerto sempre entra como recebida
            origemAcertoId: acertoId,
            dataRegistro: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection("caixa").add(lancamentoData);
    }

    /** Atualiza Lan√ßamento de Caixa ap√≥s Edi√ß√£o de Acerto */
    async function atualizarLancamentoCaixaAcerto(acertoId, motorista, novaSobra, novaDataViagem) {
        const caixaQuery = await db.collection("caixa").where("origemAcertoId", "==", acertoId).get();
        if (!caixaQuery.empty) {
            const docRef = caixaQuery.docs[0].ref;
            // CORRE√á√ÉO 1: Remover o ID do acerto da descri√ß√£o
            const novaDescricao = `Sobra Viagem - Motorista: ${motorista}`;
            await docRef.update({
                valor: novaSobra,
                descricao: novaDescricao,
                data: firebase.firestore.Timestamp.fromDate(new Date(novaDataViagem + 'T12:00:00')),
                dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
            });
        }
    }

    /** Limpa os campos do formul√°rio de Acerto */
    function limparCamposAcerto() {
        document.getElementById('motoristaAcerto').value = '';
        document.getElementById('caminhaoAcerto').value = '';
        document.getElementById('freteAcerto').value = '';
        document.getElementById('comissaoAcerto').value = '';
        document.getElementById('formaPagamentoAcerto').value = '';
        document.getElementById('observacoesAcerto').value = '';
        document.getElementById('dataViagemAcerto').value = '';
        document.getElementById('sobraAcerto').textContent = floatToCurrency(0);
        despesasViagem = [];
        renderizarDespesas();
        acertoEmEdicaoId = null;
        document.querySelector('#acertos button[onclick="salvarAcerto()"]').textContent = 'üíæ Salvar Acerto';
    }

    /** Carrega e Exibe Acertos com Filtros */
    async function carregarAcertos() {
        const tabela = document.getElementById('acertosTable');
        const mobileList = document.getElementById('acertosMobileList');
        tabela.innerHTML = '<tr><td colspan="7" class="text-center py-4">Carregando acertos...</td></tr>';
        mobileList.innerHTML = '<div class="text-center py-4">Carregando acertos...</div>';

        const dataInicio = document.getElementById('dataInicioAcerto').value;
        const dataFim = document.getElementById('dataFimAcerto').value;
        let query = db.collection("acertos").orderBy("dataViagem", "desc");

        if (dataInicio) {
            query = query.where("dataViagem", ">=", firebase.firestore.Timestamp.fromDate(new Date(dataInicio + 'T00:00:00')));
        }
        if (dataFim) {
            // Adiciona 1 dia para incluir a data final
            const endDate = new Date(dataFim + 'T23:59:59'); // Ajuste para incluir o dia inteiro
            query = query.where("dataViagem", "<=", firebase.firestore.Timestamp.fromDate(endDate));
        }

        try {
            const snapshot = await query.get();
            let totalFrete = 0, totalComissao = 0, totalDespesas = 0, totalSobra = 0;
            tabela.innerHTML = ''; // Limpa antes de renderizar
            mobileList.innerHTML = '';

            if (snapshot.empty) {
                 const emptyMsg = '<tr><td colspan="7" class="text-center py-4">Nenhum acerto encontrado para o per√≠odo.</td></tr>';
                 tabela.innerHTML = emptyMsg;
                 mobileList.innerHTML = '<div class="text-center py-4">Nenhum acerto encontrado para o per√≠odo.</div>';
                 // Atualiza totais para zero
                 document.getElementById('totalFreteAcerto').textContent = floatToCurrency(0);
                 document.getElementById('totalComissaoAcerto').textContent = floatToCurrency(0);
                 document.getElementById('totalDespesasAcerto').textContent = floatToCurrency(0);
                 document.getElementById('totalSobraAcerto').textContent = floatToCurrency(0);
                 return;
            }

            snapshot.forEach(doc => {
                const acerto = doc.data();
                acerto.id = doc.id;
                
                totalFrete += acerto.frete || 0;
                totalComissao += acerto.comissao || 0;
                totalDespesas += acerto.totalDespesas || 0;
                totalSobra += acerto.sobra || 0;

                const dataFormatada = acerto.dataViagem ? formatDateBR(acerto.dataViagem.toDate().toISOString().split('T')[0]) : '-';
                const totalDespesasMonetario = floatToCurrency(acerto.totalDespesas || 0);

                const acoesHtml = `
                    <button onclick="abrirModalResumoViagem('${acerto.id}')" class="text-gray-600 hover:text-blue-900 mr-2 small-btn" title="Resumo/Despesas">üëÅÔ∏è</button>
                    <button onclick="editarAcerto('${acerto.id}')" class="text-blue-600 hover:text-blue-900 mr-2 small-btn" title="Editar">‚úèÔ∏è</button>
                    <button onclick="excluirAcerto('${acerto.id}')" class="text-red-600 hover:text-red-900 mr-2 small-btn" title="Excluir">üóëÔ∏è</button>
                    <button onclick="abrirModalAssinaturaRecibo('${acerto.id}')" class="text-green-600 hover:text-green-900 small-btn" title="Recibo">üìÑ</button>
                `;
                
                // ----------------------------------------
                // 1. Renderiza√ß√£o para DESKTOP (Tabela)
                // ----------------------------------------
                tabela.innerHTML += `
                    <tr class="hover:bg-gray-100">
                        <td class="px-6 py-4 whitespace-nowrap">${acerto.motorista}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${acerto.caminhaoNome || acerto.caminhaoId}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${floatToCurrency(acerto.frete || 0)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-red-600">${floatToCurrency(acerto.comissao || 0)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-red-600 relative">
                            ${totalDespesasMonetario}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-green-700">${floatToCurrency(acerto.sobra || 0)}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            ${acoesHtml}
                        </td>
                    </tr>
                `;

                // ----------------------------------------
                // 2. Renderiza√ß√£o para MOBILE (Cards)
                // ----------------------------------------
                mobileList.innerHTML += `
                    <div class="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                        <div class="flex justify-between items-start mb-2">
                            <p class="font-bold text-lg text-blue-700">${acerto.motorista}</p>
                            <span class="text-xs text-gray-500">${dataFormatada}</span>
                        </div>
                        <p class="text-sm text-gray-600 mb-1">Caminh√£o: ${acerto.caminhaoNome || acerto.caminhaoId}</p>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <p>Frete: <span class="font-semibold text-blue-800">${floatToCurrency(acerto.frete || 0)}</span></p>
                            <p>Comiss√£o: <span class="font-semibold text-red-600">${floatToCurrency(acerto.comissao || 0)}</span></p>
                            <p>Despesas: <span class="font-semibold text-red-600">${totalDespesasMonetario}</span></p>
                            <p>Sobra: <span class="font-bold text-green-700">${floatToCurrency(acerto.sobra || 0)}</span></p>
                        </div>
                        <div class="mt-3 pt-3 border-t flex justify-end">
                            ${acoesHtml}
                        </div>
                    </div>
                `;
            });

            // Atualiza totais
            document.getElementById('totalFreteAcerto').textContent = floatToCurrency(totalFrete);
            document.getElementById('totalComissaoAcerto').textContent = floatToCurrency(totalComissao);
            document.getElementById('totalDespesasAcerto').textContent = floatToCurrency(totalDespesas);
            document.getElementById('totalSobraAcerto').textContent = floatToCurrency(totalSobra);

        } catch (error) {
            console.error("Erro ao carregar acertos:", error);
            const errorMsg = '<tr><td colspan="7" class="text-center py-4 text-red-500">Erro ao carregar dados. Verifique o console.</td></tr>';
            tabela.innerHTML = errorMsg;
            mobileList.innerHTML = '<div class="text-center py-4 text-red-500">Erro ao carregar dados. Verifique o console.</div>';
        }
    }

    /** Abre o modal de resumo detalhado da viagem (o "Olhinho") */
    async function abrirModalResumoViagem(acertoId) {
        try {
            const doc = await db.collection('acertos').doc(acertoId).get();
            if (!doc.exists) {
                console.error('Acerto n√£o encontrado!');
                return;
            }
            acertoAtualData = doc.data();
            
            let placa = 'N/A';
            if (acertoAtualData.caminhaoId) {
                const caminhaoDoc = await db.collection('caminhoes').doc(acertoAtualData.caminhaoId).get();
                if (caminhaoDoc.exists) {
                    placa = caminhaoDoc.data().placa;
                }
            }

            const dataViagemNormalizada = toDate(acertoAtualData.dataViagem);
            
            document.getElementById('resumoData').textContent = dataViagemNormalizada ? formatDateBR(dataViagemNormalizada.toISOString().split('T')[0]) : '-';
            document.getElementById('resumoMotorista').textContent = acertoAtualData.motorista;
            document.getElementById('resumoCaminhao').textContent = `${acertoAtualData.caminhaoNome || 'N/A'} (${placa})`;
            document.getElementById('resumoFrete').textContent = floatToCurrency(acertoAtualData.frete || 0);
            document.getElementById('resumoComissao').textContent = floatToCurrency(acertoAtualData.comissao || 0);
            document.getElementById('resumoFormaPagamento').textContent = acertoAtualData.formaPagamento || 'N/A';
            document.getElementById('resumoTotalDespesas').textContent = floatToCurrency(acertoAtualData.totalDespesas || 0);
            document.getElementById('resumoSobra').textContent = floatToCurrency(acertoAtualData.sobra || 0);
            document.getElementById('resumoObservacoes').textContent = acertoAtualData.observacoes || 'N/A';

            // Lista de Despesas
            const listaDespesas = document.getElementById('resumoListaDespesas');
            listaDespesas.innerHTML = '';
            (acertoAtualData.despesas || []).forEach(d => {
                listaDespesas.innerHTML += `<li>- ${d.descricao}: ${floatToCurrency(d.valor)}</li>`;
            });
            if (listaDespesas.innerHTML === '') {
                listaDespesas.innerHTML = '<li>Nenhuma despesa registrada.</li>';
            }

            document.getElementById('modalResumoViagem').classList.remove('hidden');
            document.getElementById('modalResumoViagem').style.display = "flex";
        } catch (error) {
            console.error('Erro ao buscar acerto para resumo:', error);
            // alert('Erro ao carregar dados para resumo.'); // N√£o usar alert
        }
    }


    function filtrarAcertos() {
        carregarAcertos(); 
    }

    /** Editar Acerto */
    async function editarAcerto(acertoId) {
        acertoEmEdicaoId = acertoId;
        document.querySelector('#acertos button[onclick="salvarAcerto()"]').textContent = 'üîÑ Atualizar Acerto';
        
        try {
            const doc = await db.collection('acertos').doc(acertoId).get();
            if (!doc.exists) {
                console.error('Acerto n√£o encontrado!');
                return;
            }
            const acerto = doc.data();
            const dataViagemNormalizada = toDate(acerto.dataViagem);

            document.getElementById('motoristaAcerto').value = acerto.motorista;
            document.getElementById('caminhaoAcerto').value = acerto.caminhaoId;
            document.getElementById('freteAcerto').value = floatToCurrency(acerto.frete || 0);
            document.getElementById('comissaoAcerto').value = floatToCurrency(acerto.comissao || 0);
            document.getElementById('formaPagamentoAcerto').value = acerto.formaPagamento || '';
            document.getElementById('observacoesAcerto').value = acerto.observacoes || '';
            document.getElementById('dataViagemAcerto').value = dataViagemNormalizada ? dataViagemNormalizada.toISOString().split('T')[0] : '';
            
            // Carrega despesas para edi√ß√£o
            despesasViagem = acerto.despesas || [];
            renderizarDespesas();
            calcularSobra();

            window.scrollTo({ top: 0, behavior: 'smooth' }); // Volta para o topo do formul√°rio
        } catch (error) {
            console.error('Erro ao buscar acerto para edi√ß√£o:', error);
            // alert('Erro ao carregar dados para edi√ß√£o.'); // N√£o usar alert
        }
    }

    /** Excluir Acerto */
    async function excluirAcerto(acertoId) {
        if (!confirm('Tem certeza que deseja excluir este acerto e o lan√ßamento de sobra no caixa?')) return;
        
        try {
            // Exclui o lan√ßamento de caixa relacionado (se existir)
            const caixaQuery = await db.collection("caixa").where("origemAcertoId", "==", acertoId).get();
            const batch = db.batch();
            caixaQuery.forEach(doc => {
                batch.delete(doc.ref);
            });
            await batch.commit();

            // Exclui o acerto
            await db.collection("acertos").doc(acertoId).delete();
            console.log('Acerto e lan√ßamento de caixa exclu√≠dos com sucesso!');
            carregarAcertos();
            loadAllCaixaAndFilter();
        } catch (error) {
            console.error("Erro ao excluir acerto:", error);
            // alert("Erro ao excluir acerto. Verifique o console."); // N√£o usar alert
        }
    }

    /** Abre Modal de Assinatura para Recibo */
    async function abrirModalAssinaturaRecibo(acertoId) {
        try {
            const doc = await db.collection('acertos').doc(acertoId).get();
            if (!doc.exists) {
                console.error('Acerto n√£o encontrado!');
                return;
            }
            acertoAtualData = doc.data(); // Guarda os dados para usar no PDF
            acertoAtualData.id = acertoId;
            
            // Limpa canvas ao abrir
            limparAssinatura('Motorista', true);
            limparAssinatura('Proprietario', true);

            document.getElementById('modalAssinaturaRecibo').classList.remove('hidden');
            document.getElementById('modalAssinaturaRecibo').style.display = "flex";
            
            // Re-inicializa canvas para garantir que funcionem (necess√°rio para redimensionamento em mobile)
            initCanvas('Motorista');
            initCanvas('Proprietario');

        } catch (error) {
            console.error('Erro ao abrir modal de assinatura:', error);
            // alert('Erro ao carregar dados para assinatura.'); // N√£o usar alert
        }
    }

    /** Inicializa Canvas de Assinatura (CORRIGIDO PARA DPR E RESPONSIVIDADE) */
    function initCanvas(id) {
        const canvas = document.getElementById(`canvas${id}`);
        if (!canvas) return; 

        const ctx = canvas.getContext('2d');
        const dpr = window.devicePixelRatio || 1; // Obt√©m o Device Pixel Ratio
        
        let isDrawing = false;
        let lastX = 0;
        let lastY = 0;

        // Obt√©m o tamanho VIS√çVEL do canvas (pelo CSS/Layout)
        const rect = canvas.getBoundingClientRect();
        const displayWidth = rect.width;
        const displayHeight = rect.height; 

        // Define a resolu√ß√£o INTERNA do canvas multiplicada pelo DPR
        canvas.width = displayWidth * dpr;
        canvas.height = displayHeight * dpr; 
        
        // Define o tamanho VIS√çVEL (CSS) novamente (boa pr√°tica)
        canvas.style.width = `${displayWidth}px`;
        canvas.style.height = `${displayHeight}px`;

        // Normaliza todas as opera√ß√µes de desenho para o DPR (escala o contexto)
        ctx.scale(dpr, dpr);

        // Limpa o canvas e configura o pincel
        ctx.fillStyle = '#fff';
        ctx.fillRect(0, 0, displayWidth, displayHeight); // Usa o tamanho visual para a limpeza
        ctx.strokeStyle = '#000'; 
        ctx.lineWidth = 2;
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round'; 

        function draw(e) {
            if (!isDrawing) return;

            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            // NOVO C√ÅLCULO: Usa o rect do display e o dpr j√° foi aplicado no ctx.scale
            const currentX = clientX - rect.left;
            const currentY = clientY - rect.top;
            
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(currentX, currentY);
            ctx.stroke();
            
            lastX = currentX;
            lastY = currentY;
            
            e.preventDefault();
        }

        function startDrawing(e) {
            isDrawing = true;
            let clientX, clientY;
            if (e.touches && e.touches.length > 0) {
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }
            
            // Define o ponto inicial usando as coordenadas relativas ao canvas visual
            lastX = clientX - rect.left;
            lastY = clientY - rect.top;
            
            // Desenha um ponto para toques r√°pidos
            ctx.beginPath();
            ctx.arc(lastX, lastY, ctx.lineWidth / 2, 0, 2 * Math.PI);
            ctx.fillStyle = ctx.strokeStyle;
            ctx.fill();
            
            e.preventDefault();
        }

        function stopDrawing() {
            isDrawing = false;
        }

        // Remove listeners antigos para evitar duplica√ß√£o (boas pr√°ticas)
        ['mousedown', 'mousemove', 'mouseup', 'mouseout', 'touchstart', 'touchmove', 'touchend', 'touchcancel'].forEach(event => {
            canvas.removeEventListener(event, startDrawing);
            canvas.removeEventListener(event, draw);
            canvas.removeEventListener(event, stopDrawing);
        });
        
        // Adiciona eventos (Mouse e Touch)
        canvas.addEventListener('mousedown', startDrawing);
        canvas.addEventListener('mousemove', draw);
        canvas.addEventListener('mouseup', stopDrawing);
        canvas.addEventListener('mouseout', stopDrawing);
        
        canvas.addEventListener('touchstart', startDrawing);
        canvas.addEventListener('touchmove', draw);
        canvas.addEventListener('touchend', stopDrawing);
        canvas.addEventListener('touchcancel', stopDrawing);

        // Atualiza a vari√°vel global do canvas para refer√™ncia
        if (id === 'Motorista') window.canvasMotorista = canvas;
        else if (id === 'Proprietario') window.canvasProprietario = canvas;
    }

    /** Limpa o Canvas de Assinatura */
    function limparAssinatura(type, skipAlert = false) {
        const canvas = document.getElementById(`canvas${type}`);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        // Limpa o canvas (preenche com branco para garantir)
        ctx.fillStyle = '#fff';
        // Ajuste de Limpeza para a escala do DPR
        const rect = canvas.getBoundingClientRect();
        const displayWidth = rect.width;
        const displayHeight = rect.height;
        ctx.fillRect(0, 0, displayWidth, displayHeight); 
        
        if (!skipAlert) console.log(`Assinatura do ${type} limpa!`);
    }

    /** Salva assinaturas e prepara a abertura do Recibo */
    function salvarAssinaturasEGerarRecibo() {
        const assMotorista = document.getElementById('canvasMotorista').toDataURL('image/png');
        const assProprietario = document.getElementById('canvasProprietario').toDataURL('image/png');
        
        // Armazena as assinaturas no objeto de dados atual
        acertoAtualData.assinaturaMotorista = assMotorista;
        acertoAtualData.assinaturaProprietario = assProprietario;

        // Fecha o modal de assinatura e abre o modal de recibo
        fecharModalAssinaturaRecibo();
        abrirModalRecibo(acertoAtualData);
    }
    
    /** Abre o Modal do Recibo com Assinaturas */
    async function abrirModalRecibo(acerto) {
        try {
            // Tenta buscar a placa pelo ID do caminh√£o
            let placa = 'N/A';
            if (acerto.caminhaoId) {
                const caminhaoDoc = await db.collection('caminhoes').doc(acerto.caminhaoId).get();
                if (caminhaoDoc.exists) {
                    placa = caminhaoDoc.data().placa;
                }
            }

            const dataViagemNormalizada = toDate(acerto.dataViagem);


            document.getElementById('reciboEmpresa').textContent = localStorage.getItem("nomeEmpresa") || 'Nome da Empresa';
            document.getElementById('reciboMotorista').textContent = acerto.motorista;
            document.getElementById('reciboCaminhao').textContent = `${acerto.caminhaoNome || 'N/A'} (${placa})`;
            document.getElementById('reciboData').textContent = dataViagemNormalizada ? formatDateBR(dataViagemNormalizada.toISOString().split('T')[0]) : '-';
            document.getElementById('reciboComissao').textContent = floatToCurrency(acerto.comissao || 0);
            document.getElementById('reciboObservacoes').textContent = acerto.observacoes || 'N/A';
            document.getElementById('reciboDataGeracao').textContent = new Date().toLocaleString('pt-BR');

            // Injeta as imagens de assinatura
            document.getElementById('reciboAssMotorista').src = acerto.assinaturaMotorista || '';
            document.getElementById('reciboAssProprietario').src = acerto.assinaturaProprietario || '';

            document.getElementById('modalRecibo').classList.remove('hidden');
            document.getElementById('modalRecibo').style.display = "flex";
            window.acertoParaRecibo = acerto; // Armazena globalmente para PDF
        } catch (error) {
            console.error('Erro ao gerar recibo:', error);
            // alert('Erro ao carregar dados para o recibo.'); // N√£o usar alert
        }
    }


    /** Gerar PDF do Recibo (usando html2canvas) - CORRIGIDO PARA QUEBRA DE P√ÅGINA */
    function gerarReciboPDF() {
        if (typeof html2canvas === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
            console.error('Bibliotecas de PDF n√£o carregadas. Recurso indispon√≠vel.');
            return;
        }
        
        const element = document.getElementById('reciboParaPDF');
        const filename = `Recibo_${window.acertoParaRecibo.motorista}.pdf`;

        // Aumentar a escala para melhor qualidade em telas de alta resolu√ß√£o
        html2canvas(element, { scale: 3 }).then(canvas => { 
            const imgData = canvas.toDataURL('image/png');
            // Formato A4: 210mm x 297mm (retrato)
            const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            
            // Largura da imagem no PDF: 190mm (20mm de margem total)
            const imgWidth = 190; 
            const imgHeight = canvas.height * imgWidth / canvas.width;
            
            let heightLeft = imgHeight;
            let position = 10; // Margem superior inicial (10mm)
            
            // Adiciona a primeira p√°gina
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= (pdfHeight - position); // Subtrai o espa√ßo j√° ocupado na primeira p√°gina

            // Adiciona p√°ginas extras se o conte√∫do for maior que uma p√°gina
            while (heightLeft > 0) {
                position = 10; // Nova margem superior para a pr√≥xima p√°gina
                pdf.addPage();
                
                // O Y negativo na imagem √© o quanto ela subiu (rolou)
                // O 10 √© a margem superior
                pdf.addImage(imgData, 'PNG', 10, - (imgHeight - heightLeft), imgWidth, imgHeight); 
                heightLeft -= (pdfHeight - position);
            }

            pdf.save(filename);
        }).catch(error => {
            console.error('Erro ao gerar PDF do Recibo:', error);
            // alert('Erro ao gerar PDF do recibo. Verifique o console.'); // N√£o usar alert
        });
    }

    /** Gerar Relat√≥rio de Acertos (PDF) */
    function gerarRelatorioAcertoPDF() {
        if (typeof html2canvas === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
            console.error('Bibliotecas de PDF n√£o carregadas. Recurso indispon√≠vel.');
            return;
        }

        // T√≠tulo e Tabela (Desktop)
        const titulo = document.createElement('h2');
        titulo.textContent = 'Relat√≥rio de Acertos de Viagem';
        titulo.style.textAlign = 'center';

        const dataRange = `Per√≠odo: ${document.getElementById('dataInicioAcerto').value || 'In√≠cio'} a ${document.getElementById('dataFimAcerto').value || 'Fim'}`;
        const totalFrete = document.getElementById('totalFreteAcerto').textContent;
        const totalComissao = document.getElementById('totalComissaoAcerto').textContent;
        const totalSobra = document.getElementById('totalSobraAcerto').textContent;
        
        const totaisDiv = document.createElement('div');
        totaisDiv.innerHTML = `
            <p><strong>${dataRange}</strong></p>
            <p>Total Frete: ${totalFrete} | Total Comiss√£o: ${totalComissao} | **Total Sobra: ${totalSobra}**</p>
        `;
        totaisDiv.style.marginBottom = '10px';
        totaisDiv.style.fontSize = '12px';

        const tabelaOriginal = document.getElementById('acertosTable').closest('table');
        
        // Clona a tabela e remove as colunas de A√ß√µes para o PDF
        const tabelaClone = tabelaOriginal.cloneNode(true);
        // Remove a √∫ltima coluna (A√ß√µes)
        tabelaClone.querySelectorAll('tr').forEach(row => {
            if (row.cells.length > 0) {
                 row.deleteCell(row.cells.length - 1);
            }
        });
        tabelaClone.querySelector('thead tr th:last-child').remove(); // Remove o cabe√ßalho A√ß√µes

        // Cria um container tempor√°rio para renderizar o PDF
        const tempContainer = document.createElement('div');
        tempContainer.style.width = '1050px'; // Define uma largura fixa para o PDF (para simular desktop)
        tempContainer.style.padding = '20px';
        tempContainer.append(titulo, totaisDiv, tabelaClone);
        
        document.body.appendChild(tempContainer);
        
        html2canvas(tempContainer, { 
            scale: 2,
            windowWidth: 1200, // For√ßa a largura de renderiza√ß√£o
            scrollY: -window.scrollY 
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF('l', 'mm', 'a4'); // 'l' para landscape (paisagem)
            
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = 280; // Largura do conte√∫do (A4 paisagem)
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 10;
            
            pdf.addImage(imgData, 'PNG', 8, position, imgWidth, imgHeight);
            heightLeft -= pdfHeight;
            
            // Adiciona p√°ginas para tabelas muito longas (se necess√°rio)
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 8, position, imgWidth, imgHeight);
                heightLeft -= pdfHeight;
            }

            pdf.save(`Relatorio_Acertos_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`);
            
            // Remove o container tempor√°rio
            tempContainer.remove();
        }).catch(error => {
            console.error('Erro ao gerar PDF do Relat√≥rio:', error);
            tempContainer.remove();
        });
    }

    /** Gerar Relat√≥rio de Caixa (PDF) */
    function gerarRelatorioCaixaPDF() {
        if (typeof html2canvas === 'undefined' || typeof jspdf.jsPDF === 'undefined') {
            console.error('Bibliotecas de PDF n√£o carregadas. Recurso indispon√≠vel.');
            return;
        }

        // T√≠tulo e Tabela (Desktop)
        const titulo = document.createElement('h2');
        titulo.textContent = 'Relat√≥rio de Movimenta√ß√£o de Caixa';
        titulo.style.textAlign = 'center';

        const totalEntradas = document.getElementById('totalEntradasCaixa').textContent;
        const totalSaidas = document.getElementById('totalSaidasCaixa').textContent;
        const saldoAtual = document.getElementById('saldoAtualCaixa').textContent;
        
        const totaisDiv = document.createElement('div');
        totaisDiv.innerHTML = `
            <p>Total Entradas: ${totalEntradas} | Total Sa√≠das: ${totalSaidas} | **Saldo: ${saldoAtual}**</p>
        `;
        totaisDiv.style.marginBottom = '10px';
        totaisDiv.style.fontSize = '12px';
        
        const tabelaOriginal = document.getElementById('caixaTable').closest('table');
        
        // Clona a tabela e remove as colunas de A√ß√µes para o PDF
        const tabelaClone = tabelaOriginal.cloneNode(true);
        // Remove a √∫ltima coluna (A√ß√µes)
        tabelaClone.querySelectorAll('tr').forEach(row => {
            if (row.cells.length > 0) {
                 row.deleteCell(row.cells.length - 1);
            }
        });
        tabelaClone.querySelector('thead tr th:last-child').remove(); // Remove o cabe√ßalho A√ß√µes

        // Cria um container tempor√°rio para renderizar o PDF
        const tempContainer = document.createElement('div');
        tempContainer.style.width = '1050px'; // Define uma largura fixa para o PDF (para simular desktop)
        tempContainer.style.padding = '20px';
        tempContainer.append(titulo, totaisDiv, tabelaClone);
        
        document.body.appendChild(tempContainer);
        
        html2canvas(tempContainer, { 
            scale: 2,
            windowWidth: 1200, // For√ßa a largura de renderiza√ß√£o
            scrollY: -window.scrollY 
        }).then(canvas => {
            const imgData = canvas.toDataURL('image/png');
            const pdf = new jspdf.jsPDF('l', 'mm', 'a4'); // 'l' para landscape (paisagem)
            
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            const imgWidth = 280; // Largura do conte√∫do (A4 paisagem)
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;
            let position = 10;
            
            pdf.addImage(imgData, 'PNG', 8, position, imgWidth, imgHeight);
            heightLeft -= pdfHeight;
            
            // Adiciona p√°ginas para tabelas muito longas (se necess√°rio)
            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 8, position, imgWidth, imgHeight);
                heightLeft -= pdfHeight;
            }

            pdf.save(`Relatorio_Caixa_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`);
            
            // Remove o container tempor√°rio
            tempContainer.remove();
        }).catch(error => {
            console.error('Erro ao gerar PDF do Relat√≥rio:', error);
            tempContainer.remove();
        });
    }

    /** Chama o Gemini para sugerir uma categoria baseada na descri√ß√£o */
    async function sugerirCategoria() {
        const descricao = document.getElementById('descricaoCaixa').value.trim();
        const categoriaInput = document.getElementById('categoriaCaixa');

        if (!descricao) {
            console.error("Por favor, preencha a Descri√ß√£o para obter uma sugest√£o.");
            return;
        }

        categoriaInput.value = "Aguarde, analisando...";
        
        const systemPrompt = "Voc√™ √© um especialista em contabilidade de frotas. Dada a descri√ß√£o de uma transa√ß√£o, retorne APENAS a categoria financeira mais apropriada (m√°ximo 3 palavras). Exemplos: 'Combust√≠vel', 'Ped√°gio', 'Manuten√ß√£o', 'Sal√°rio', 'Aluguel', 'Frete', 'Outros'.";
        const userQuery = `Qual categoria para: "${descricao}"?`;
        
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] },
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "N√£o foi poss√≠vel sugerir.";
            
            categoriaInput.value = text.replace(/["'.]/g, ''); // Limpa aspas e pontos
        } catch (error) {
            console.error("Erro ao chamar a API Gemini:", error);
            categoriaInput.value = "Erro na API.";
        }
    }


    /** Exibe/Oculta campos de vencimento/cheque no modal de NOVO lan√ßamento */
    function toggleVencimentoCheque() {
        const tipo = document.getElementById('tipoCaixa').value;
        const isSaida = tipo === 'saida';
        const isBoleto = document.getElementById('isBoleto').checked;
        const isCheque = document.getElementById('isCheque').checked;
        const qtdParcelas = parseInt(document.getElementById('qtdParcelas').value) || 1;
        const dataVencimentoStr = document.getElementById('dataVencimento').value;
        const desdobramentoDiv = document.getElementById('desdobramentoParcelas');
        const tabelaParcelasBody = document.getElementById('tabelaParcelas');
        const valorTotal = currencyToFloat(document.getElementById('valorCaixa').value);

        document.getElementById('opcoesParcela').classList.toggle('hidden', !isSaida);
        
        if (isSaida && (isBoleto || isCheque) && qtdParcelas > 0 && dataVencimentoStr && valorTotal > 0) {
            desdobrarParcelas(qtdParcelas, dataVencimentoStr, isCheque ? 'apresentacao' : 'vencimento', valorTotal);
            desdobramentoDiv.classList.remove('hidden');
        } else {
            desdobramentoDiv.classList.add('hidden');
            tabelaParcelasBody.innerHTML = '';
        }

        document.getElementById('headerDataParcela').textContent = isCheque ? 'Apresenta√ß√£o' : 'Vencimento';
        document.getElementById('labelVencimento').textContent = isCheque ? 'Apresenta√ß√£o da 1¬™ Parcela' : 'Vencimento da 1¬™ Parcela';
    }

    /** Calcula e exibe a tabela de desdobramento de parcelas */
    function desdobrarParcelas(qtd, dataInicioStr, tipo, valorTotal) {
        const valorParcela = valorTotal / qtd;
        const dataInicio = new Date(dataInicioStr + 'T12:00:00'); // Evita problemas de timezone

        let html = '';
        for (let i = 0; i < qtd; i++) {
            const dataParcela = new Date(dataInicio);
            dataParcela.setMonth(dataParcela.getMonth() + i);

            const dataFormatada = dataParcela.toISOString().split('T')[0];
            const tipoDoc = tipo === 'vencimento' ? 'Boleto' : 'Cheque';

            html += `
                <tr>
                    <td>${i + 1}/${qtd}</td>
                    <td>${floatToCurrency(valorParcela)}</td>
                    <td><input type="date" value="${dataFormatada}" id="${tipo}Parcela${i}" class="border p-1 rounded text-sm w-36"></td>
                    <td>${tipoDoc}</td>
                </tr>
            `;
        }
        document.getElementById('tabelaParcelas').innerHTML = html;
    }

    /** Salva Lan√ßamento Manual (Incluindo Parcelas) */
    async function salvarLancamentoCaixa() {
        const tipo = document.getElementById('tipoCaixa').value;
        const valorTotal = currencyToFloat(document.getElementById('valorCaixa').value);
        const data = document.getElementById('dataCaixa').value; // String YYYY-MM-DD
        const categoria = document.getElementById('categoriaCaixa').value.trim();
        const descricao = document.getElementById('descricaoCaixa').value.trim();

        if (valorTotal <= 0 || !data) {
            console.error('Preencha o Tipo, Valor e Data de Lan√ßamento!');
            return;
        }

        const isBoleto = document.getElementById('isBoleto').checked;
        const isCheque = document.getElementById('isCheque').checked;
        const qtdParcelas = parseInt(document.getElementById('qtdParcelas').value) || 1;

        // Converte a data de lan√ßamento para Timestamp (centralizado)
        const dataLancamentoTimestamp = firebase.firestore.Timestamp.fromDate(new Date(data + 'T12:00:00'));

        try {
            if (tipo === 'saida' && (isBoleto || isCheque)) {
                // Lan√ßamento Parcelado
                const valorParcela = valorTotal / qtdParcelas;
                const lancamentos = [];
                const tipoParcela = isBoleto ? 'vencimento' : 'apresentacao';
                
                for (let i = 0; i < qtdParcelas; i++) {
                    const dataParcelaStr = document.getElementById(`${tipoParcela}Parcela${i}`)?.value;
                    
                    if (!dataParcelaStr) {
                         // Erro cr√≠tico: data de vencimento/apresenta√ß√£o n√£o encontrada para a parcela
                         console.error(`Erro: Data da parcela ${i + 1} n√£o preenchida ou n√£o encontrada.`);
                         return;
                    }

                    lancamentos.push({
                        tipo,
                        valor: valorParcela,
                        data: dataLancamentoTimestamp, // Data de Lan√ßamento
                        dataVencimento: firebase.firestore.Timestamp.fromDate(new Date(dataParcelaStr + 'T12:00:00')), // Data de Vencimento/Apresenta√ß√£o
                        categoria: categoria || 'Despesa Parcelada',
                        descricao: `${descricao || 'Despesa Parcelada'} (${i + 1}/${qtdParcelas})`,
                        status: 'a pagar',
                        parcela: `${i + 1}/${qtdParcelas}`,
                        tipoDocumento: isBoleto ? 'Boleto' : 'Cheque',
                        dataRegistro: firebase.firestore.FieldValue.serverTimestamp()
                    });
                }

                const batch = db.batch();
                lancamentos.forEach(lancamento => {
                    batch.set(db.collection("caixa").doc(), lancamento);
                });
                await batch.commit();
                console.log('Lan√ßamentos parcelados criados com sucesso!');

            } else {
                // Lan√ßamento Simples (Entrada ou Sa√≠da √† vista)
                const lancamento = {
                    tipo,
                    valor: valorTotal,
                    data: dataLancamentoTimestamp,
                    categoria: categoria || (tipo === 'entrada' ? 'Receita Diversa' : 'Despesa √† Vista'),
                    descricao: descricao || (tipo === 'entrada' ? 'Entrada Manual' : 'Sa√≠da Manual'),
                    dataVencimento: tipo === 'saida' ? dataLancamentoTimestamp : null, // Sa√≠da √† vista = Vencimento √© igual √† Data de Lan√ßamento
                    status: tipo === 'entrada' ? 'recebido' : 'pago', // Se √© √† vista, assume que j√° est√° pago/recebido
                    dataRegistro: firebase.firestore.FieldValue.serverTimestamp()
                };
                await db.collection("caixa").add(lancamento);
                console.log(`Lan√ßamento de ${tipo} simples salvo com sucesso!`);
            }

            limparCamposCaixa();
            loadAllCaixaAndFilter();

        } catch (error) {
            console.error("Erro ao salvar lan√ßamento manual:", error);
        }
    }

    /** Limpa campos do Caixa */
    function limparCamposCaixa() {
        document.getElementById('tipoCaixa').value = 'entrada';
        document.getElementById('valorCaixa').value = '';
        document.getElementById('dataCaixa').value = '';
        document.getElementById('categoriaCaixa').value = '';
        document.getElementById('descricaoCaixa').value = '';
        document.getElementById('isBoleto').checked = false;
        document.getElementById('isCheque').checked = false;
        document.getElementById('qtdParcelas').value = 1;
        document.getElementById('dataVencimento').value = '';
        document.getElementById('desdobramentoParcelas').classList.add('hidden');
        toggleVencimentoCheque();
    }
    
    /** Fun√ß√£o principal de filtro e totais */
    function filtrarCaixaEAtualizarTotais(items) {
      // items pode vir vazio -> tenta pegar window.caixaItems
      items = items || window.caixaItems || [];
      // elementos (IDs padr√£o; ajusta caso seu HTML use outros)
      const fLancEl = document.getElementById('filtroTipoRecebimento');
      const fVencEl = document.getElementById('filtroTipoVencimento');
      const fMesEl = document.getElementById('filtroMes');
      
      const fLanc = fLancEl ? fLancEl.checked : false;
      const fVenc = fVencEl ? fVencEl.checked : false;

      const lancStartVal = (document.getElementById('dataInicioCaixa')||{value:''}).value;
      const lancEndVal   = (document.getElementById('dataFimCaixa')  ||{value:''}).value;

      let lancStart = null;
      let lancEnd   = null;
      
      // 1. Defini√ß√£o do Per√≠odo (lancStart / lancEnd)
      
      // Prioriza filtro por m√™s
      if (fMesEl && fMesEl.value) {
          const [year, month] = fMesEl.value.split('-');
          lancStart = new Date(year, month - 1, 1, 0, 0, 0); // startOfDay
          lancEnd   = new Date(year, month, 0, 23, 59, 59, 999); // endOfDay
      }
      // Sobrescreve com filtro de data manual se fornecido (apenas se o input n√£o estiver vazio)
      if (lancStartVal) lancStart = startOfDay(parseLocalDateFromInput(lancStartVal));
      if (lancEndVal) lancEnd = endOfDay(parseLocalDateFromInput(lancEndVal));

      const vencStart = lancStart; // Usamos o mesmo range para vencimento (no modo Realizado)
      const vencEnd   = lancEnd;

      // Se nenhum filtro de data foi preenchido, tratamos como "sem filtro de data"
      const temFiltroData = lancStart || lancEnd;

      // tabela alvo e tot elements
      const tbody = document.getElementById('caixaTable') || null;
      if (tbody) tbody.innerHTML = '';

      let totalEntradas = 0;
      let totalSaidas = 0;
      const mostrados = [];

      items.forEach(raw => {
        // normaliza campos
        const tipoRaw = (raw.tipo || raw.type || '').toString().toLowerCase();
        const tipo = (tipoRaw === 'entrada' || tipoRaw === 'recebimento') ? 'entrada' :
                     (tipoRaw === 'saida' || tipoRaw === 'sa√≠da' || tipoRaw === 'despesa') ? 'saida' :
                     tipoRaw || '';

        const valor = parseNumber(raw.valor ?? raw.value ?? raw.amount ?? raw.vlr ?? 0);
        const dataLanc = toDate(raw.data || raw.dataLancamento || raw.lancamento || raw.createdAt) ;
        const dataVenc = toDate(raw.dataVencimento || raw.vencimento || raw.venc || raw.dueDate);
        const forma = (raw.forma || raw.form || '') + '';
        const descricao = (raw.descricao || raw.description || raw.obs || raw.note || '') + '';

        // decide incluir
        let incluir = false;
        
        // Regra de Filtro
        if (!temFiltroData && !fLanc && !fVenc) {
            // Regra 1: Sem filtro de data e sem checkbox => inclui tudo
            incluir = true;
        } else {
            // Se houver filtro de data E/OU checkbox:
            
            // Entradas (Filtradas por Lan√ßamento)
            if (tipo === 'entrada') {
                if (fLanc) { // Se Recebimento marcado
                    incluir = inRange(dataLanc, lancStart, lancEnd);
                } else if (!fVenc && !fLanc && temFiltroData) {
                    // Filtro de data simples ativo (sem checkbox)
                    incluir = inRange(dataLanc, lancStart, lancEnd);
                }
            } 
            // Sa√≠das (Filtradas por Vencimento se fVenc, ou Lan√ßamento se fLanc)
            else if (tipo === 'saida') {
                // Filtro por Vencimento (Foco: Pagamentos a fazer no per√≠odo)
                if (fVenc) {
                    incluir = inRange(dataVenc, vencStart, vencEnd);
                } 
                // Filtro por Lan√ßamento (Foco: Despesas registradas no per√≠odo)
                else if (fLanc) {
                    incluir = inRange(dataLanc, lancStart, lancEnd);
                }
                // Filtro de Data Simples (Data customizada ativa, mas sem checkbox)
                else if (!fLanc && !fVenc && temFiltroData) {
                    // Assume que se a data est√° ativa, queremos ver Sa√≠das por vencimento OU lan√ßamento no range
                    incluir = inRange(dataLanc, lancStart, lancEnd) || inRange(dataVenc, vencStart, vencEnd);
                }
            }
        }
        
        // Se a inclus√£o foi confirmada e n√£o √© duplicado
        if (incluir && !mostrados.some(m => m.id === raw.id)) {
          
          mostrados.push({ id: raw.id || raw._id || '', tipo, valor, dataLanc, dataVenc, forma, descricao, status: raw.status });
          if (tipo === 'entrada') totalEntradas += valor;
          else if (tipo === 'saida') totalSaidas += valor;
        }
      });

      // renderiza tabela (se existir)
      if (tbody) {
        mostrados.sort((a, b) => (b.dataLanc?.getTime() || 0) - (a.dataLanc?.getTime() || 0)); // Ordena por data de lan√ßamento
        
        if (mostrados.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Nenhum lan√ßamento encontrado para os filtros.</td></tr>';
        } else {
            tbody.innerHTML = '';
            const hoje = startOfDay(new Date()); // Usando startOfDay para compara√ß√£o de data
            mostrados.forEach(it => {
              const tr = document.createElement('tr');
              const dLanc = it.dataLanc ? it.dataLanc.toLocaleDateString('pt-BR') : '-';
              const dVenc = it.dataVenc ? it.dataVenc.toLocaleDateString('pt-BR') : '-';
              
              const isEntrada = it.tipo === 'entrada';
              const dataVencNormalizada = it.dataVenc ? startOfDay(it.dataVenc) : null;
              
              // Verifica se est√° vencido (n√£o √© entrada, tem vencimento, vencimento < hoje, e n√£o est√° pago)
              const isVencido = !isEntrada && dataVencNormalizada && dataVencNormalizada < hoje && it.status !== 'pago';
              const classValor = isEntrada ? 'text-green-700' : (isVencido ? 'text-red-700' : 'text-red-600');
              
              // Bot√£o Pagar/Estornar
              let btnPagar = '';
              if (!isEntrada && it.status === 'a pagar') {
                  btnPagar = `<button onclick="mudarStatusCaixa('${it.id}', 'pago')" class="text-green-600 hover:text-green-900 mr-2 small-btn" title="Pagar">‚úÖ Pagar</button>`;
              } else if (!isEntrada && it.status === 'pago') {
                  btnPagar = `<button onclick="mudarStatusCaixa('${it.id}', 'a pagar')" class="text-yellow-600 hover:text-yellow-800 mr-2 small-btn" title="Estornar Pagamento">‚Ü©Ô∏è Estornar</button>`;
              }

              tr.className = `hover:bg-gray-100 ${isVencido ? 'bg-red-50' : ''}`;

              tr.innerHTML = `
                  <td class="px-6 py-4 whitespace-nowrap">${dLanc}</td>
                  <td class="px-6 py-4 whitespace-nowrap ${isEntrada ? 'text-green-600' : 'text-red-600'}">${(it.tipo || '').toUpperCase()}</td>
                  <td class="px-6 py-4">${it.descricao}</td>
                  <td class="px-6 py-4 whitespace-nowrap text-right font-bold ${classValor}">${formatBRL(it.valor)}</td>
                  <td class="px-6 py-4 whitespace-nowrap">${dVenc} (${it.status === 'pago' ? 'Pago' : (isVencido ? 'Vencido' : it.status)})</td>
                  <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                      <button onclick="editarLancamentoCaixa('${it.id}')" class="text-blue-600 hover:text-blue-900 mr-2 small-btn" title="Editar">‚úèÔ∏è</button>
                      ${btnPagar}
                      <button onclick="excluirLancamentoCaixa('${it.id}')" class="text-red-600 hover:text-red-900 small-btn" title="Excluir">üóëÔ∏è</button>
                  </td>`;
              tbody.appendChild(tr);
            });
        }
      }

      // atualiza totalizadores (tenta IDs padr√£o do seu HTML)
      const saldo = totalEntradas - totalSaidas;
      document.getElementById('totalEntradasCaixa').textContent = formatBRL(totalEntradas);
      document.getElementById('totalSaidasCaixa').textContent = formatBRL(totalSaidas);
      document.getElementById('saldoAtualCaixa').textContent = formatBRL(saldo);
      
      // Chamada para verificar alertas usando TODOS os itens carregados
      verificarAlertasVencimento(window.caixaItems); 
      
      console.log('[filtrarCaixa] total itens=', items.length, ' exibidos=', mostrados.length, ' totEntradas=', totalEntradas, ' totSaidas=', totalSaidas);
    }
    
    /** Inicializa o Listener do Firestore e carrega os dados iniciais */
    function loadAllCaixaAndFilter() {
        // Exibe "Carregando" na tabela
        document.getElementById('caixaTable').innerHTML = '<tr><td colspan="6" class="text-center py-4">Carregando dados...</td></tr>';
        
        const query = db.collection("caixa").orderBy("dataRegistro", "desc");
        
        query.get()
        .then(snapshot => {
            // Mapeia todos os documentos para o array global
            window.caixaItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            
            // 1. Aplica o filtro e renderiza a tabela
            filtrarCaixaEAtualizarTotais(window.caixaItems);
            
            // 2. O alerta de vencimento √© chamado DENTRO do filtrarCaixaEAtualizarTotais
        })
        .catch(error => {
            console.error("Erro ao carregar dados iniciais do caixa:", error);
            document.getElementById('caixaTable').innerHTML = '<tr><td colspan="6" class="text-center py-4 text-red-500">Erro ao carregar dados. Verifique o console.</td></td>';
        });
    }

    /** Mudar Status de Pagamento (Pagar/Estornar) */
    async function mudarStatusCaixa(lancamentoId, novoStatus) {
        // N√£o usar confirm()
        console.warn(`Tentando mudar status do lan√ßamento ${lancamentoId} para ${novoStatus}.`);

        try {
            await db.collection("caixa").doc(lancamentoId).update({
                status: novoStatus,
                dataPagamento: novoStatus === 'pago' ? firebase.firestore.FieldValue.serverTimestamp() : null
            });
            // Recarrega todos os dados e aplica o filtro
            loadAllCaixaAndFilter(); 
            console.log(`Lan√ßamento ${novoStatus === 'pago' ? 'pago' : 'estornado'} com sucesso!`);
        } catch (error) {
            console.error("Erro ao mudar status:", error);
            // alert("Erro ao realizar a opera√ß√£o."); // N√£o usar alert
        }
    }


    /** Excluir Lan√ßamento */
    async function excluirLancamentoCaixa(lancamentoId) {
        // N√£o usar confirm()
        console.warn(`Tentativa de excluir lan√ßamento ${lancamentoId}. Excluindo...`);
        
        try {
            await db.collection("caixa").doc(lancamentoId).delete();
            console.log('Lan√ßamento exclu√≠do com sucesso!');
            loadAllCaixaAndFilter();
        } catch (error) {
            console.error("Erro ao excluir lan√ßamento:", error);
            // alert("Erro ao excluir lan√ßamento. Verifique o console."); // N√£o usar alert
        }
    }

    /** Abre Modal para Edi√ß√£o de Lan√ßamento */
    async function editarLancamentoCaixa(lancamentoId) {
        lancamentoEmEdicaoId = lancamentoId;
        document.getElementById('lancamentoIdCaixa').value = lancamentoId;
        
        try {
            const doc = await db.collection('caixa').doc(lancamentoId).get();
            if (!doc.exists) {
                console.error('Lan√ßamento n√£o encontrado!');
                return;
            }
            const lancamento = doc.data();

            const dataNormalizada = toDate(lancamento.data);
            const vencimentoNormalizada = toDate(lancamento.dataVencimento);


            document.getElementById('editTipoCaixa').value = lancamento.tipo;
            document.getElementById('editValorCaixa').value = floatToCurrency(lancamento.valor || 0);
            document.getElementById('editDataCaixa').value = dataNormalizada ? dataNormalizada.toISOString().split('T')[0] : '';
            document.getElementById('editCategoriaCaixa').value = lancamento.categoria || '';
            document.getElementById('editDescricaoCaixa').value = lancamento.descricao;
            
            // Vencimento (para Parcelados/Sa√≠das)
            if (vencimentoNormalizada) {
                document.getElementById('editDataVencimento').value = vencimentoNormalizada.toISOString().split('T')[0];
                document.getElementById('editOpcoesParcela').classList.remove('hidden');
                document.getElementById('editLabelVencimento').textContent = (lancamento.tipoDocumento === 'Cheque' ? 'Apresenta√ß√£o' : 'Vencimento');
                document.getElementById('editParcAtual').textContent = lancamento.parcela ? lancamento.parcela.split('/')[0] : 1;
                document.getElementById('editParcTotal').textContent = lancamento.parcela ? lancamento.parcela.split('/')[1] : 1;
            } else {
                document.getElementById('editOpcoesParcela').classList.add('hidden');
            }

            document.getElementById('modalCaixa').classList.remove('hidden');
            document.getElementById('modalCaixa').style.display = "flex";
        } catch (error) {
            console.error('Erro ao buscar lan√ßamento para edi√ß√£o:', error);
            // alert('Erro ao carregar dados para edi√ß√£o.'); // N√£o usar alert
        }
    }

    function fecharModalCaixa() {
        document.getElementById('modalCaixa').classList.add('hidden');
        document.getElementById('modalCaixa').style.display = "none";
        lancamentoEmEdicaoId = null;
    }

    /** Salva Edi√ß√£o de Lan√ßamento */
    async function salvarEdicaoCaixa() {
        const id = document.getElementById('lancamentoIdCaixa').value;
        const tipo = document.getElementById('editTipoCaixa').value;
        const valor = currencyToFloat(document.getElementById('editValorCaixa').value);
        const data = document.getElementById('editDataCaixa').value;
        const categoria = document.getElementById('editCategoriaCaixa').value.trim();
        const descricao = document.getElementById('editDescricaoCaixa').value.trim();
        const dataVencimento = document.getElementById('editDataVencimento').value;

        if (valor <= 0 || !data) {
            console.error('Preencha os campos obrigat√≥rios (Tipo, Valor e Data).');
            return;
        }

        const updates = {
            tipo,
            valor,
            data: firebase.firestore.Timestamp.fromDate(new Date(data + 'T12:00:00')),
            categoria,
            descricao: descricao || 'Lan√ßamento Manual (Editado)',
            dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp()
        };

        if (dataVencimento && dataVencimento !== "") {
            updates.dataVencimento = firebase.firestore.Timestamp.fromDate(new Date(dataVencimento + 'T12:00:00'));
        } else {
            // Se o campo de vencimento foi limpo na edi√ß√£o, garanta que seja salvo como null
             updates.dataVencimento = null; 
        }

        try {
            await db.collection("caixa").doc(id).update(updates);
            console.log('Lan√ßamento atualizado com sucesso!');
            fecharModalCaixa();
            loadAllCaixaAndFilter();
        } catch (error) {
            console.error('Erro ao salvar edi√ß√£o:', error);
            // alert('Erro ao salvar edi√ß√£o do lan√ßamento.'); // N√£o usar alert
        }
    }

    /** Verifica e Exibe Alertas de Vencimento */
    function verificarAlertasVencimento(lancamentos) {
        // Usa normalizeToDate para comparar apenas o dia
        const hoje = normalizeToDate(new Date()); 

        const vencidos = lancamentos.filter(l => {
            const vencimento = toDate(l.dataVencimento);
            if (!vencimento) return false;
            
            const dataVencNormalizada = normalizeToDate(vencimento);
            
            // Verifica se √© sa√≠da, est√° a pagar (ou n√£o est√° pago) e o dia de vencimento √© HOJE ou ANTES
            return l.tipo === 'saida' && 
                dataVencNormalizada && 
                dataVencNormalizada.getTime() <= hoje.getTime() && 
                l.status !== 'pago';
        });
        
        // Filtra para mostrar apenas os vencidos que N√ÉO foram pagos
        const vencidosNaoPagos = vencidos.filter(l => l.status !== 'pago');
        
        const alertaDiv = document.getElementById('alertaVencimentos');
        const listaUl = document.getElementById('listaVencimentos');
        
        if (vencidosNaoPagos.length > 0) {
            alertaDiv.classList.remove('hidden');
            listaUl.innerHTML = vencidosNaoPagos.map(v => {
                const vencimento = toDate(v.dataVencimento);
                const dataVenc = vencimento ? vencimento.toLocaleDateString('pt-BR') : '-';
                
                // Classifica se vencido hoje ou atrasado
                const statusTexto = (startOfDay(vencimento).getTime() === hoje.getTime()) ? 'VENCE HOJE' : 'ATRASADO';

                return `<li>[${statusTexto}] ${v.descricao} (${floatToCurrency(v.valor)})</li>`;
            }).join('');
        } else {
            alertaDiv.classList.add('hidden');
        }
    }

    // ----------------------------------------------------
    // # L√ìGICA DO CADASTRO DE CAMINH√ÉO (ABA CAMINHAO)
    // ----------------------------------------------------

    /** Limpa formul√°rio de Caminh√£o e volta para o modo Cadastro */
    function limparCamposCaminhao() {
        document.getElementById('nomeCaminhao').value = '';
        document.getElementById('placaCaminhao').value = '';
        caminhaoEmEdicaoId = null;
        document.getElementById('tituloCaminhao').textContent = 'Cadastro de Caminh√µes';
        document.getElementById('btnSalvarCaminhao').textContent = 'üíæ Salvar Caminh√£o';
        document.getElementById('btnLimparCaminhao').classList.add('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    /** Salva ou Edita Caminh√£o */
    async function salvarCaminhao() {
        const nome = document.getElementById('nomeCaminhao').value.trim();
        const placa = document.getElementById('placaCaminhao').value.trim();

        if (!nome || !placa) {
            console.error('Preencha Nome e Placa do Caminh√£o.');
            return;
        }

        const caminhaoData = { nome, placa };

        try {
            if (caminhaoEmEdicaoId) {
                // Edi√ß√£o
                await db.collection("caminhoes").doc(caminhaoEmEdicaoId).update(caminhaoData);
                console.log('Caminh√£o atualizado com sucesso!');
            } else {
                // Novo Cadastro
                await db.collection("caminhoes").add(caminhaoData);
                console.log('Caminh√£o salvo com sucesso!');
            }
            
            limparCamposCaminhao();
            carregarCaminhoes();
            carregarOptionsCaminhao(); // Atualiza a lista de sele√ß√£o
        } catch (error) {
            console.error("Erro ao salvar/atualizar caminh√£o:", error);
            // alert("Erro ao salvar/atualizar caminh√£o. Verifique o console."); // N√£o usar alert
        }
    }

    /** Prepara o formul√°rio para edi√ß√£o de um caminh√£o */
    async function editarCaminhao(caminhaoId) {
        try {
            const doc = await db.collection('caminhoes').doc(caminhaoId).get();
            if (!doc.exists) {
                console.error('Caminh√£o n√£o encontrado!');
                return;
            }
            const caminhao = doc.data();
            
            caminhaoEmEdicaoId = caminhaoId;
            document.getElementById('nomeCaminhao').value = caminhao.nome;
            document.getElementById('placaCaminhao').value = caminhao.placa;
            document.getElementById('tituloCaminhao').textContent = 'Editar Caminh√£o';
            document.getElementById('btnSalvarCaminhao').textContent = 'üîÑ Atualizar Caminh√£o';
            document.getElementById('btnLimparCaminhao').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' }); // Volta para o formul√°rio
        } catch (error) {
            console.error('Erro ao buscar caminh√£o para edi√ß√£o:', error);
            // alert('Erro ao carregar dados do caminh√£o para edi√ß√£o.'); // N√£o usar alert
        }
    }


    /** Carrega e Exibe Caminh√µes */
    async function carregarCaminhoes() {
        const tabelaBody = document.getElementById('caminhoesTableBody');
        tabelaBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">Carregando caminh√µes...</td></tr>';
        
        try {
            const snapshot = await db.collection("caminhoes").orderBy("nome", "asc").get();
            tabelaBody.innerHTML = ''; // Limpa antes de renderizar

            if (snapshot.empty) {
                tabelaBody.innerHTML = '<tr><td colspan="3" class="text-center py-4">Nenhum caminh√£o cadastrado.</td></tr>';
                return;
            }

            snapshot.forEach(doc => {
                const caminhao = doc.data();
                caminhao.id = doc.id;

                tabelaBody.innerHTML += `
                    <tr class="hover:bg-gray-100">
                        <td class="px-6 py-4 whitespace-nowrap">${caminhao.nome}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${caminhao.placa}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <button onclick="editarCaminhao('${caminhao.id}')" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar">‚úèÔ∏è</button>
                            <button onclick="excluirCaminhao('${caminhao.id}')" class="text-red-600 hover:text-red-900" title="Excluir">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });

        } catch (error) {
            console.error("Erro ao carregar caminh√µes:", error);
            tabelaBody.innerHTML = '<tr><td colspan="3" class="text-center py-4 text-red-500">Erro ao carregar dados.</td></tr>';
        }
    }

    /** Excluir Caminh√£o */
    async function excluirCaminhao(caminhaoId) {
        // N√£o usar confirm()
        console.warn(`Tentativa de excluir caminh√£o ${caminhaoId}. Excluindo...`);
        
        try {
            await db.collection("caminhoes").doc(caminhaoId).delete(); 
            
            console.log('Caminh√£o exclu√≠do com sucesso!');
            carregarCaminhoes(); // Atualiza a tabela
            carregarOptionsCaminhao(); // Atualiza a lista de sele√ß√£o
        } catch (error) {
            console.error("Erro ao excluir caminh√£o:", error);
            // alert("Erro ao excluir caminh√£o. Verifique o console."); // N√£o usar alert
        }
    }


    /** Carrega Caminh√µes no <select> de Acerto */
    async function carregarOptionsCaminhao() {
        const select = document.getElementById('caminhaoAcerto');
        select.innerHTML = '<option value="">Selecione o Caminh√£o</option>';

        try {
            const snapshot = await db.collection("caminhoes").orderBy("nome", "asc").get();
            snapshot.forEach(doc => {
                const caminhao = doc.data();
                select.innerHTML += `<option value="${doc.id}">${caminhao.nome} - ${caminhao.placa}</option>`;
            });
        } catch (error) {
            console.error("Erro ao carregar options de caminh√£o:", error);
        }
    }

    // ----------------------------------------------------
    // # FUN√á√ïES GERAIS E INICIALIZA√á√ÉO
    // ----------------------------------------------------

    /** Ordena Tabela */
    function ordenarTabela(tableId, columnIndex) {
        const tabela = document.getElementById(tableId);
        let switching = true;
        let dir = "asc"; 
        let shouldSwitch;
        let i;
        
        const tbody = tabela.querySelector('tbody');
        if (!tbody) return;
        const th = tabela.querySelectorAll("th")[columnIndex];

        // 1. Alterna entre asc e desc (usando data-ordem)
        const ordem = th.dataset.ordem === "asc" ? "desc" : "asc";
        tabela.querySelectorAll("th").forEach(th => th.removeAttribute("data-ordem"));
        th.dataset.ordem = ordem;

        const linhas = Array.from(tbody.querySelectorAll("tr"));


        linhas.sort((a, b) => {
            const aText = a.children[columnIndex].textContent.trim();
            const bText = b.children[columnIndex].textContent.trim();
            
            let resultado = 0;
            let isNumeric = a.children[columnIndex].className.includes("text-right");
            
            // Tratamento de Data (Colunas 0 e 4 na tabela Caixa, Coluna 2/5 na tabela Acerto)
            const isDateCol = (tableId === 'caixaTable' && (columnIndex === 0 || columnIndex === 4)) || (tableId === 'acertosTable' && (columnIndex === 2 || columnIndex === 5));
            
            if (isDateCol) {
                // Se for data, usa parseDateBR para obter o timestamp
                resultado = parseDateBR(aText).getTime() - parseDateBR(bText).getTime();
            } else if (isNumeric) {
                // Se for valor, usa parseNumber
                resultado = parseNumber(aText) - parseNumber(bText);
            } else {
                // Para texto, usa localeCompare
                resultado = aText.localeCompare(bText, 'pt-BR', { numeric: true });
            }

            return ordem === "asc" ? resultado : -resultado;
        });

        // 3. Reinsere as linhas ordenadas
        tbody.innerHTML = "";
        linhas.forEach(l => tbody.appendChild(l));
    }

    /** Inicializa√ß√£o do Sistema (ap√≥s login) */
    function initSystem() {
        // Carrega nome da empresa
        const nomeEmpresa = localStorage.getItem("nomeEmpresa") || "Nome da Empresa";
        document.getElementById("nomeEmpresaHeader").innerText = nomeEmpresa;
        document.getElementById("novoNomeEmpresa").value = nomeEmpresa;

        // Inicializa Canvas de Assinatura (para garantir que sejam configurados)
        // initCanvas('Motorista'); // N√£o chamamos aqui, mas sim ao abrir o modal
        // initCanvas('Proprietario');

        // Carrega dados iniciais
        carregarOptionsCaminhao();
        carregarAcertos();
        loadAllCaixaAndFilter(); // Chamada inicial de carga e filtro do caixa
    }
    
    /** Inicializa√ß√£o ao carregar a p√°gina */
    window.onload = () => {
        // Inicializa√ß√£o do Canvas em onload (importante para o redimensionamento inicial)
        // O redimensionamento deve acontecer dentro de initCanvas() ao abrir o modal,
        // mas as vari√°veis globais precisam ser inicializadas.

        // Login Persistente
        if (localStorage.getItem("usuarioLogado") === "true") {
            document.getElementById("loginPage").style.display = "none";
            document.getElementById("appPage").classList.remove("hidden");
            initSystem();
            changeTab('acertos'); // Garante a aba correta
        } else {
            // Garante que o app esteja escondido e o login vis√≠vel
            document.getElementById("loginPage").style.display = "flex";
            document.getElementById("appPage").classList.add("hidden");
        }
    };
    
// Alias para o bot√£o do filtro
function filtrarCaixa() {
    loadAllCaixaAndFilter(); // Chama a fun√ß√£o principal de carga e filtro
}
</script>
</body> 
</html>
